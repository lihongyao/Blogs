# æ¦‚è¿°

## 1. èµ·æº

[Babel >>](<https://www.babeljs.cn/>) æœ€åˆåä¸º **6to5**ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ **es6** è½¬ **es5**ï¼Œä½†æ˜¯åæ¥éšç€ ECMAScript æ ‡å‡†çš„æ¼”è¿›ï¼Œæœ‰äº† ES7ã€ES8ã€ESNext ç­‰ç­‰ï¼Œ **6to5** çš„åå­—å·²ç»ä¸åˆé€‚äº†ï¼Œå› æ­¤å›¢é˜Ÿå† 2014 å¹´å†³å®šå°†å®ƒé‡å‘½åä¸º **babel**ã€‚

Babel æ˜¯ [å·´åˆ«å¡”](https://baike.baidu.com/item/%E5%B7%B4%E5%88%AB%E5%A1%94/67557) çš„æ„æ€ï¼Œæ¥è‡ªåœ£ç»ä¸­çš„å…¸æ•…ï¼š

> äººç±»æ›¾è¯•å›¾å»ºé€ é€šå¾€å¤©å ‚çš„é«˜å¡”ï¼Œä¸Šå¸é€šè¿‡åˆ¶é€ è¯­è¨€éš”é˜‚ä½¿åä½œå¤±è´¥ï¼Œå¯¼è‡´å·¥ç¨‹ä¸­æ­¢ã€‚è¿™ä¸€éšå–»å·§å¦™å‘¼åº”äº† Babel çš„ä½¿å‘½â€”â€”**è§£å†³ JavaScript ä¸åŒç‰ˆæœ¬é—´çš„"è¯­è¨€éš”é˜‚"**ï¼Œè®©å¼€å‘è€…èƒ½ç”¨æœ€æ–°è¯­æ³•ç¼–å†™è·¨ç¯å¢ƒå…¼å®¹çš„ä»£ç ã€‚

## 2. ç”¨é€”

1. è¯­æ³•è½¬æ¢
2. é€šè¿‡ Polyfill æ–¹å¼åœ¨ç›®æ ‡ç¯å¢ƒä¸­æ·»åŠ ç¼ºå¤±çš„åŠŸèƒ½ï¼ˆé€šè¿‡å¼•å…¥ç¬¬ä¸‰æ–¹ polyfill æ¨¡å—ï¼Œä¾‹å¦‚ [core-js](https://github.com/zloirock/core-js)ï¼‰
3. æºç è½¬æ¢ï¼ˆcodemodsï¼‰

```js
// Babel æ¥æ”¶åˆ°çš„è¾“å…¥æ˜¯ï¼š ES2015 ç®­å¤´å‡½æ•°
[1, 2, 3].map(n => n + 1);

// Babel è¾“å‡ºï¼š ES5 è¯­æ³•å®ç°çš„åŒç­‰åŠŸèƒ½
[1, 2, 3].map(function(n) {
  return n + 1;
});
```

## 3. è½¬æ¢å·¥å…·

- **ç¼–è¯‘å™¨ï¼ˆ`Compiler`ï¼‰**ï¼š

  - ä½œç”¨ï¼šå°† **é«˜çº§è¯­è¨€**ï¼ˆå¦‚ Cã€Javaï¼‰è½¬æ¢ä¸º **ä½çº§è¯­è¨€**ï¼ˆå¦‚æ±‡ç¼–ã€æœºå™¨ç ï¼‰

  - ç‰¹ç‚¹ï¼š
    - è¾“å‡ºä»£ç ä¸ç¡¬ä»¶ç›¸å…³ï¼ˆå¦‚ CPU æŒ‡ä»¤ã€å†…å­˜ç®¡ç†ï¼‰ã€‚
    - éœ€è¦å¼€å‘è€…ç†è§£è®¡ç®—æœºåº•å±‚åŸç†ï¼ˆå¯„å­˜å™¨ã€å†…å­˜æ“ä½œï¼‰ã€‚
    - å…¸å‹ä¾‹å­ï¼š`GCC`ï¼ˆC/C++ ç¼–è¯‘å™¨ï¼‰ã€`LLVM`ï¼ˆä¼˜åŒ–ç¼–è¯‘æ¡†æ¶ï¼‰ã€‚

- **è½¬è¯‘å™¨ï¼ˆ`Transpiler`ï¼‰**ï¼š

  - å°†**é«˜çº§è¯­è¨€**ï¼ˆå¦‚ ES6+ JavaScriptï¼‰è½¬æ¢ä¸º**å¦ä¸€ç§é«˜çº§è¯­è¨€**ï¼ˆå¦‚ ES5 JavaScriptï¼‰
    - è¾“å‡ºä»£ç ä»ç„¶å¯è¯»ï¼Œé€‚åˆå¼€å‘è€…è°ƒè¯•ã€‚
    - ä¸æ¶‰åŠåº•å±‚ç¡¬ä»¶ï¼Œä»…åšè¯­æ³•è½¬æ¢ã€‚
    - å…¸å‹ä¾‹å­ï¼š`Babel`ã€`TypeScript Compiler (tsc)`ã€`SWC`ï¼ˆRust ç¼–å†™çš„ JS è½¬è¯‘å™¨ï¼‰ã€‚

**é«˜çº§è¯­è¨€** vs. **ä½çº§è¯­è¨€** ï¼ˆäº†è§£å³å¯ï¼‰

| **ç‰¹æ€§**     | **é«˜çº§è¯­è¨€**ï¼ˆå¦‚ JavaScriptã€Pythonï¼‰ | **ä½çº§è¯­è¨€**ï¼ˆå¦‚æ±‡ç¼–ã€æœºå™¨ç ï¼‰ |
| ------------ | ------------------------------------- | ------------------------------ |
| **æŠ½è±¡ç¨‹åº¦** | é«˜ï¼ˆæ¥è¿‘äººç±»æ€ç»´ï¼‰                    | ä½ï¼ˆæ¥è¿‘æœºå™¨æŒ‡ä»¤ï¼‰             |
| **å¼€å‘æ•ˆç‡** | é«˜ï¼ˆæ˜“è¯»ã€æ˜“ç»´æŠ¤ï¼‰                    | ä½ï¼ˆéœ€å…³æ³¨åº•å±‚ç»†èŠ‚ï¼‰           |
| **æ‰§è¡Œé€Ÿåº¦** | è¾ƒæ…¢ï¼ˆéœ€è§£é‡Š/ç¼–è¯‘ï¼‰                   | æå¿«ï¼ˆç›´æ¥è¿è¡Œï¼‰               |
| **å…¸å‹ç”¨é€”** | Web å¼€å‘ã€åº”ç”¨é€»è¾‘                    | åµŒå…¥å¼ç³»ç»Ÿã€é©±åŠ¨å¼€å‘           |

> ç»“è®ºï¼š
>
> 1. `Babel` æ˜¯ä¸€ä¸ª **JavaScript è½¬è¯‘å™¨ï¼ˆ`Transpiler`ï¼‰**ï¼Œè´Ÿè´£å°†æ–°ç‰ˆ JavaScriptï¼ˆå¦‚ ES6+ï¼‰è½¬æ¢ä¸ºå…¼å®¹æ€§æ›´å¥½çš„æ—§ç‰ˆ JavaScriptï¼ˆå¦‚ ES5ï¼‰ã€‚
> 2. å°½ç®¡ [å®˜ç½‘ >>](https://www.babeljs.cn/) æ ‡é¢˜ä»‹ç» **Babel æ˜¯ä¸€ä¸ª JavaScript ç¼–è¯‘å™¨**ï¼Œä½†ä¸ªäººè®¤ä¸ºï¼Œä»–æ˜¯ä¸€ä¸ªè½¬è¯‘å™¨ï¼å„ä½çœ‹å®˜å¦‚ä½•çœ‹å‘¢ ğŸ¤”

## 4. ç¼–è¯‘æµç¨‹

Babel çš„ç¼–è¯‘æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. è§£æï¼ˆParsingï¼‰ï¼šå°†æºä»£ç è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œæ„å»ºä»£ç çš„ç»“æ„åŒ–è¡¨ç¤ºã€‚
2. è½¬æ¢ï¼ˆTransformationï¼‰ï¼šé€šè¿‡æ’ä»¶ç³»ç»Ÿéå†å¹¶ä¿®æ”¹ ASTï¼Œå®ç°è¯­æ³•é™çº§æˆ–åŠŸèƒ½è½¬æ¢ã€‚
3. ç”Ÿæˆï¼ˆCode Generationï¼‰ï¼šå°†å¤„ç†åçš„ AST é‡æ–°ç”Ÿæˆä¸ºç›®æ ‡ç‰ˆæœ¬çš„ JavaScript ä»£ç ã€‚

ç®€å•ç†è§£ï¼Œå°±æ˜¯ï¼š`Parse` â†’ `Transform` â†’ `Generate`

# AST - æŠ½è±¡è¯­æ³•æ ‘

## 1. What's ASTï¼Ÿ

![](./IMGS/javascript_ast.png)

**æŠ½è±¡è¯­æ³•æ ‘**ï¼ˆ**A**bstract **S**yntax **T**reeï¼ŒASTï¼‰æ˜¯å¯¹ç¨‹åºä»£ç è¿›è¡Œç»“æ„åŒ–è¡¨ç¤ºçš„ **<u>æ ‘çŠ¶æ•°æ®ç»“æ„</u>**ï¼Œç”¨äºåœ¨ç¼–ç¨‹è¯­è¨€å¤„ç†å’Œè½¬æ¢è¿‡ç¨‹ä¸­è¿›è¡Œä»£ç åˆ†æå’Œæ“ä½œã€‚

## 2. ç”¨é€”

ASTåœ¨å‰ç«¯æ— å¤„ä¸åœ¨ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„å¼€å‘å·¥å…·å‡ ä¹å…¨ä¾èµ–äºASTè¿›è¡Œå¼€å‘ï¼šæ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„babelæ’ä»¶å°† es6 â†’ es5 ã€ts â†’ js ã€ä»£ç å‹ç¼©ã€CSSé¢„å¤„ç†å™¨ã€eslintç­‰ç­‰ï¼Œä»–ä»¬åœ¨æˆ‘ä»¬çš„å®é™…å¼€å‘ä¸­éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œè€Œä»–ä»¬çš„åº•å±‚åŸç†å…¶å®ä¹Ÿéƒ½æ˜¯ASTã€‚å¦‚æœä½ æƒ³äº†è§£ js ç¼–è¯‘æ‰§è¡Œï¼ˆæ¯”å¦‚V8å¼•æ“çš„ç¼–è¯‘æ‰§è¡Œè¿‡ç¨‹ï¼‰çš„åŸç†å¹¶æŒæ¡å…¶ç²¾é«“ï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»å¾—äº†è§£ ASTã€‚

## 3. AST å¦‚ä½•ç”Ÿæˆï¼Ÿ

æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰çš„ç”Ÿæˆè¿‡ç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1. è¯æ³•åˆ†æï¼ˆLexical Analysisï¼‰ï¼šå°†æºä»£ç åˆ†è§£æˆè¯æ³•å•å…ƒï¼ˆTokensï¼‰ï¼Œå¦‚æ ‡è¯†ç¬¦ã€å…³é”®å­—ã€è¿ç®—ç¬¦ç­‰ã€‚
2. è¯­æ³•åˆ†æï¼ˆParsingï¼‰ï¼šæ ¹æ®è¯­æ³•è§„åˆ™å°†è¯æ³•å•å…ƒç»„ç»‡æˆè¯­æ³•ç»“æ„ï¼Œæ„å»ºåˆæ­¥çš„è¯­æ³•æ ‘ã€‚
3. è¯­ä¹‰åˆ†æï¼ˆSemantic Analysisï¼‰ï¼šå¯¹è¯­æ³•æ ‘è¿›è¡Œé™æ€è¯­ä¹‰æ£€æŸ¥ï¼Œå¦‚å˜é‡å£°æ˜æ£€æŸ¥ã€ç±»å‹æ£€æŸ¥ç­‰ï¼Œè¿›ä¸€æ­¥å®Œå–„è¯­æ³•æ ‘ã€‚
4. ç”ŸæˆASTï¼šæ ¹æ®å®Œå–„çš„è¯­æ³•æ ‘è§„åˆ™ï¼Œæ„å»ºæœ€ç»ˆçš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä»£ç çš„ä¸åŒéƒ¨åˆ†ï¼ˆå¦‚è¡¨è¾¾å¼ã€è¯­å¥ã€å‡½æ•°ç­‰ï¼‰ï¼Œå¹¶å»ºç«‹å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚

> **æ³¨æ„ï¼š**ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å¯èƒ½å…·æœ‰ä¸åŒçš„è¯­æ³•è§„åˆ™å’Œå¤„ç†æ–¹å¼ï¼Œå› æ­¤ AST çš„ç”Ÿæˆè¿‡ç¨‹å¯èƒ½ä¼šæœ‰æ‰€å·®å¼‚ã€‚ä½†æ€»ä½“ä¸Šï¼ŒAST çš„ç”Ÿæˆæ˜¯é€šè¿‡è¯æ³•åˆ†æã€è¯­æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æç­‰æ­¥éª¤æ¥æ„å»ºå…·æœ‰ç»“æ„åŒ–è¡¨ç¤ºçš„ä»£ç æ ‘çŠ¶ç»“æ„ã€‚

### 3.1. è¯æ³•åˆ†æ â€” åˆ†è¯

è¯æ³•åˆ†æé˜¶æ®µä¸»è¦è´Ÿè´£å°†æºä»£ç æ‹†åˆ†æˆè¯æ³•å•å…ƒï¼Œå¹¶ä¸ºæ¯ä¸ªè¯æ³•å•å…ƒåˆ†é…ç›¸åº”çš„æ ‡è®°ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨æºä»£ç çš„åŸºç¡€ä¸Šè¿›è¡Œåˆ†è¯ã€‚

æ¯”å¦‚æŠŠ **â€œæˆ‘çˆ±ä¸­å›½â€**  è¿™æ®µå­—ç¬¦ä¸²æ ¹æ®æŸç§è§„åˆ™æ‹†è§£æˆ **â€œæˆ‘â€**ã€**â€œçˆ±â€**ã€**â€œä¸­å›½â€** ä¸‰éƒ¨åˆ†ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«åš **åˆ†è¯**ï¼Œå…¶ä¸­å„ä¸ªéƒ¨åˆ†åˆè¢«ç§°ä¸º **è¯æ³•å•å…ƒ** ï¼Œå¯¹äºä»£ç æ¥è¯´ï¼Œéœ€è¦å°†ä»£ç ç‰‡æ®µè¯†åˆ«ä¸ºå…³é”®å­—ã€æ ‡è¯†ç¬¦ã€æ“ä½œç¬¦ã€å­—é¢é‡ç­‰éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯åˆ†é…æ ‡è®°ã€‚

æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œè¯æ³•åˆ†æå°±æ˜¯æŠŠä½ çš„ä»£ç ä»å­—ç¬¦ä¸²ç±»å‹è½¬æ¢æˆäº†æ•°ç»„ï¼Œæ•°ç»„çš„å…ƒç´ å°±æ˜¯ä»£ç é‡Œçš„å•è¯ï¼ˆè¯æ³•å•å…ƒï¼‰ï¼Œå¹¶ä¸”æ ‡è®°äº†æ¯ä¸ªå•è¯çš„ç±»å‹ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š

```javascript
const a = 10;
```

è¯æ³•åˆ†æå™¨ **ä»å·¦å¾€å³é€ä¸ªå­—ç¬¦æ‰«æåˆ†æ** æ•´ä¸ªç¨‹åºçš„å­—ç¬¦ä¸²ï¼Œå½“é‡åˆ°ä¸åŒçš„å­—ç¬¦æ—¶ï¼Œä¼šé©±ä½¿å®ƒè¿ç§»åˆ°ä¸åŒçš„çŠ¶æ€ã€‚åœ¨æ‰«æå­—ç¬¦çš„æ—¶å€™ï¼Œé‡åˆ° `c` å­—æ¯ï¼Œå¦‚æœåé¢è¿˜æœ‰å­—ç¬¦ï¼Œå°†ç»§ç»­æ‰«æï¼Œç›´åˆ°é‡åˆ°ç©ºæ ¼ï¼Œè¯†åˆ«å‡º `const`ï¼Œå‘ç°æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œå°†å…¶ç”Ÿæˆè¯æ³•å•å…ƒï¼š

```js
{ type: 'Keyword', value: 'const' }
```

ç„¶åæ¥ç€æ‰«æï¼Œä»¥æ­¤ç±»æ¨ï¼Œç”Ÿæˆ `Token List`ã€‚

æ‰€ä»¥ï¼Œè¿™æ®µç¨‹åºä¼šè¢«åˆ†è§£æˆä¸ºä¸‹é¢è¿™äº›è¯æ³•å•å…ƒï¼š`let` ã€`a`ã€`=`ã€`10`ã€ `;`ï¼Œä½ å¯ä»¥åœ¨ [è¿™é‡Œ >>](https://esprima.org/demo/parse.html?code=const%20a%20%3D%2010%3B%0A) æŸ¥çœ‹è¯æ³•åˆ†æç»“æœï¼š

```javascript
[
  { type: 'Keyword',    value: 'const' },
  { type: 'Identifier', value: 'a'     },
  { type: 'Punctuator', value: '='     },
  { type: 'Numeric',    value: '10'    },
  { type: 'Punctuator', value: ';'     },
];
```

é€šè¿‡ä¸Šé¢åˆ†è§£å‡ºæ¥çš„è¯æ³•åˆ†æç»“æœï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œç¼ºå°‘ä¸€äº›æ¯”è¾ƒå…³é”®çš„ä¿¡æ¯ï¼š

1. æ²¡æœ‰ä»»ä½•è¯­æ³•ä¿¡æ¯ï¼›

2. ä½“ç°ä¸äº†ä»£ç çš„æ‰§è¡Œé¡ºåºï¼›

æ‰€ä»¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è¿›è¡Œ **è¯­æ³•åˆ†æ**ã€‚

### 3.2. è¯­æ³•åˆ†æ â€” è§£æ

è¯­æ³•åˆ†æä¼šå°†è¯æ³•åˆ†æå‡ºæ¥çš„ **è¯æ³•å•å…ƒ** è½¬åŒ–æˆæœ‰è¯­æ³•å«ä¹‰çš„ **æŠ½è±¡è¯­æ³•æ ‘ç»“æ„ï¼ˆASTï¼‰**ã€‚åŒæ—¶ï¼ŒéªŒè¯è¯­æ³•ï¼Œè¯­æ³•å¦‚æœæœ‰é”™çš„è¯ï¼Œå°†æŠ›å‡ºè¯­æ³•é”™è¯¯ã€‚

è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æä¸æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œè€Œæ˜¯äº¤é”™è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯æ³•åˆ†æå™¨ä¸ä¼šåœ¨è¯»å–æ‰€æœ‰çš„è¯æ³•è®°å·åå†ä½¿ç”¨è¯­æ³•åˆ†æå™¨æ¥å¤„ç†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ¯å–å¾—ä¸€ä¸ªè¯æ³•è®°å·ï¼Œå°±å°†å…¶é€å…¥è¯­æ³•åˆ†æå™¨è¿›è¡Œåˆ†æã€‚

![](./IMGS/js-token-ast.png)

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åœ¨çº¿å·¥å…·ç”Ÿæˆ ASTï¼š[AST explorer >>](https://astexplorer.net/) æˆ–è€… [Esprima.org >>](https://esprima.org/demo/parse.html)ï¼Œè¿™é‡Œä¸»è¦ç®€å•ä»‹ç»ä¸‹ `AST explorer` çš„ä½¿ç”¨ï¼š

![](./IMGS/ast_explorer.png)

æ¯”å¦‚è¿™ä¸€æ®µä»£ç ï¼š

```javascript
function square(n) {
  return n * n;
}
```

ç»è¿‡è½¬åŒ–ï¼Œè¾“å‡º **AST** ç»“æ„å¦‚ä¸‹ï¼š

![](./IMGS/ast_eg1.png)

ä½ ä¼šç•™æ„åˆ° AST çš„æ¯ä¸€å±‚éƒ½æ‹¥æœ‰ç›¸åŒçš„ç»“æ„ï¼š

```javascript
{
    type: "FunctionDeclaration",
    id: {...},
    params: [...],
    body: {...}
}
```

```javascript
{
    type: "Identifier",
    name: ...
}
```

```javascript
{
    type: "BinaryExpression",
    operator: ...,
    left: {...},
    right: {...}
}
```

> æç¤ºï¼šå‡ºäºç®€åŒ–çš„ç›®çš„ç§»é™¤äº†æŸäº›å±æ€§ã€‚

è¿™æ ·çš„æ¯ä¸€å±‚ç»“æ„ï¼Œè¢«ç§°ä¸º **èŠ‚ç‚¹**ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½åŒ…å« `type` å±æ€§ï¼Œç”¨äºè¡¨ç¤ºèŠ‚ç‚¹ç±»å‹ï¼Œæ¯”å¦‚ï¼š*`FunctionDeclaration`*ã€*`Identifier`*ã€*`BinaryExpression`* ç­‰ç­‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒBabel è¿˜ä¸ºæ¯ä¸ªèŠ‚ç‚¹é¢å¤–ç”Ÿæˆäº†ä¸€äº›å±æ€§ï¼Œç”¨äºæè¿°è¯¥èŠ‚ç‚¹åœ¨åŸå§‹ä»£ç ä¸­çš„ä½ç½®ï¼Œæ¯”å¦‚ï¼š *`start`*ã€*`end`*ã€*`loc`*ã€‚

## 4. èŠ‚ç‚¹ç±»å‹

äº†è§£äº†ASTç»“æ„çš„åŸºæœ¬å½¢çŠ¶ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»ASTèŠ‚ç‚¹ç±»å‹ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªå¤§ç±»ï¼š**å­—é¢é‡**ã€**æ ‡å¿—ç¬¦**ã€**è¯­å¥**ã€**å£°æ˜**ã€**è¡¨è¾¾å¼**ã€**æ³¨é‡Š** ç­‰ç­‰ã€‚

è¿™é‡Œä¸»è¦åˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„ç±»å‹ï¼Œæ›´å¤šèŠ‚ç‚¹ç±»å‹è¯·å‚è€ƒ [@babel/types >>](https://www.babeljs.cn/docs/babel-types#aliases)

### 4.1. å­—é¢é‡ã€Œ[Literal >>](https://www.babeljs.cn/docs/babel-types#literal)ã€

| ç±»å‹åç§°         | ä¸­æ–‡è¯‘å     | æè¿°                                      |
| ---------------- | ------------ | ----------------------------------------- |
| `StringLiteral`  | å­—ç¬¦å‹å­—é¢é‡ | é€šå¸¸æŒ‡å­—ç¬¦ä¸²ç±»å‹çš„å­—é¢é‡ï¼š`'Hello, AST!'` |
| `NumericLiteral` | æ•°å€¼å‹å­—é¢é‡ | é€šå¸¸æŒ‡æ•°å­—ç±»å‹çš„å­—é¢é‡ï¼š`123`             |
| `BooleanLiteral` | å¸ƒå°”å‹å­—é¢é‡ | é€šå¸¸æŒ‡å¸ƒå°”ç±»å‹å€¼ï¼š`true` / `false`        |
| `RegExpLiteral`  | æ­£åˆ™å‹å­—é¢é‡ | é€šå¸¸æŒ‡æ­£åˆ™è¡¨è¾¾å¼ï¼š`/[0-9]/`               |
| `TemplatLiteral` | æ¨¡æ¿å‹å­—é¢é‡ | é€šå¸¸æŒ‡æ¨¡æ¿å­—ç¬¦ä¸²ï¼ˆ`ï¼‰                     |

> *æç¤ºï¼šè¿™é‡Œä¸»è¦å±•ç¤ºå¸¸ç”¨çš„å­—é¢é‡ç±»å‹ï¼Œæ›´å¤šè¯¦æƒ…è¯·å‚è€ƒ[è¿™é‡Œ >>](https://www.babeljs.cn/docs/babel-types#literal)*

### 4.2. æ ‡å¿—ç¬¦ã€ŒIdentifierã€

ç¨‹åºä¸­æ‰€æœ‰çš„ å˜é‡åã€å‡½æ•°åã€å¯¹è±¡é”®ï¼ˆ`key`ï¼‰ ä»¥åŠå‡½æ•°ä¸­çš„å‚æ•°åï¼Œéƒ½å±äºæ ‡å¿—ç¬¦ã€‚

### 4.3. è¯­å¥ã€Œ[Statement >>](https://www.babeljs.cn/docs/babel-types#statement)ã€

è¯­å¥æ˜¯èƒ½å¤Ÿç‹¬ç«‹æ‰§è¡Œçš„åŸºæœ¬å•ä½ï¼Œå¸¸è§çš„è¯­å¥ç±»å‹æœ‰ï¼š

| ç±»å‹åç§°              | ä¸­æ–‡è¯‘å          | æè¿°                                      |
| --------------------- | ----------------- | ----------------------------------------- |
| `IfStatement`         | `If` æ§åˆ¶æµè¯­å¥   | é€šå¸¸æŒ‡ `if (true) {} else {}`             |
| `ForInStatement`      | `For-in` å¾ªç¯è¯­å¥ | é€šå¸¸æŒ‡ `for(let key in obj) {}`           |
| `SwitchStatement`     | `Switch` è¯­å¥     | é€šå¸¸æŒ‡ `switch`                           |
| `WhileStatement`      | `While` å¾ªç¯è¯­å¥  | é€šå¸¸æŒ‡ `while(true) {}`                   |
| `ForStatement`        | `For` å¾ªç¯è¯­å¥    | é€šå¸¸æŒ‡ `for(let i = 0; i < 10; i++) {}`   |
| `BreakStatement`      | ä¸­æ–­è¯­å¥          | é€šå¸¸æŒ‡ `break`                            |
| `ContinueStatement`   | æŒç»­è¯­å¥          | é€šå¸¸æŒ‡ `continue`                         |
| `ReturnStatement`     | è¿”å›è¯­å¥          | é€šå¸¸æŒ‡ `return`                           |
| `BlockStatement`      | å—è¯­å¥            | åŒ…è£¹åœ¨ `{}` å†…çš„è¯­å¥                      |
| `ExpressionStatement` | è¡¨è¾¾å¼è¯­å¥        | é€šå¸¸ä¸ºè°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œæ¯”å¦‚ `console.log(1)` |

### 4.4. å£°æ˜ã€Œ[Declaration >>](https://www.babeljs.cn/docs/babel-types#declaration)ã€

å£°æ˜è¯­å¥æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¯­å¥ï¼Œå®ƒæ‰§è¡Œçš„é€»è¾‘æ˜¯åœ¨ä½œç”¨åŸŸå†…å£°æ˜ä¸€ä¸ª `å˜é‡`ã€å‡½æ•°ã€`class`ã€`import`ã€`export` ç­‰ã€‚

| ç±»å‹åç§°                   | ä¸­æ–‡è¯‘å         | æè¿°                              |
| -------------------------- | ---------------- | --------------------------------- |
| `VariableDeclaration`      | å˜é‡å£°æ˜         | `const a = 10;`                   |
| `FunctionDeclaration`      | å‡½æ•°å£°æ˜         | `function sum() {}`               |
| `ImportDeclaration`        | æ¨¡å—å¼•å…¥å£°æ˜     | `import { reactive } from 'vue;'` |
| `ExportDefaultDeclaration` | æ¨¡å—é»˜è®¤å¯¼å‡ºå£°æ˜ | `export default a = 10;`          |

### 4.5. è¡¨è¾¾å¼ã€Œ[Expression >>](https://www.babeljs.cn/docs/babel-types#expression)ã€

è¡¨è¾¾å¼çš„ç‰¹ç‚¹æ˜¯æ‰§è¡Œå®Œä»¥åæœ‰è¿”å›å€¼ï¼Œè¿™æ˜¯å’Œè¯­å¥ (`statement`) çš„åŒºåˆ«

| ç±»å‹åç§°                  | ä¸­æ–‡è¯‘å       | æè¿°                               |
| ------------------------- | -------------- | ---------------------------------- |
| `ArrayExpression`         | æ•°ç»„è¡¨è¾¾å¼     | é€šå¸¸æŒ‡ä¸€ä¸ªæ•°ç»„ï¼š`[1, 2, 3]`        |
| `ArrowFunctionExpression` | ç®­å¤´å‡½æ•°è¡¨è¾¾å¼ | `() => {}`                         |
| `AssignmentExpression`    | èµ‹å€¼è¡¨è¾¾å¼     | é€šå¸¸æŒ‡ä¸ºä¸€ä¸ªå˜é‡èµ‹å€¼ï¼Œæ¯”å¦‚ `a = 1` |
| `BinaryExpression`        | äºŒå…ƒè¡¨è¾¾å¼     | `1 + 2`                            |
| `UnaryExpression`         | ä¸€å…ƒè¡¨è¾¾å¼     | `-1`                               |
| `FunctionExpression`      | å‡½æ•°è¡¨è¾¾å¼     | `function(){}`                     |

### 4.6. `Comment` & `Program`

| ç±»å‹åç§°       | ä¸­æ–‡è¯‘å | æè¿°             |
| -------------- | -------- | ---------------- |
| `Program`      | ç¨‹åºä¸»ä½“ | æ•´æ®µä»£ç çš„ä¸»ä½“   |
| `CommentBlock` | å—çº§æ³¨é‡Š | `/* å—çº§æ³¨é‡Š */` |
| `CommentLine`  | å•è¡Œæ³¨é‡Š | `// å•è¡Œæ³¨é‡Š`    |

# å·¥ä½œåŸç†

![](./IMGS/babel.png)

Babel çš„ç¼–è¯‘è¿‡ç¨‹å’Œå¤§å¤šæ•°å…¶ä»–è¯­è¨€çš„ç¼–è¯‘å™¨å¤§è‡´ç›¸åŒï¼Œå¯ä»¥åˆ†ä¸º **ä¸‰ä¸ªé˜¶æ®µ**ï¼š

ğŸ“Œï¼š`è§£æ(Parse)`  â†’  `è½¬æ¢(Transform)`  â†’  `ç”Ÿæˆ(Generate)`ã€‚

## 1. è§£æ â€” Parser

Babel ä½¿ç”¨ [@babel/parser](https://www.babeljs.cn/docs/babel-parser)  å°†æºä»£ç è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªå…³é”®é˜¶æ®µï¼š

- **è¯æ³•åˆ†æï¼ˆLexical Analysisï¼‰**
  - å°†æºä»£ç å­—ç¬¦ä¸²åˆ†è§£ä¸ºæœ‰æ„ä¹‰çš„è¯­æ³•å•å…ƒï¼ˆTokensï¼‰
  - æ¯ä¸ª Token åŒ…å«ç±»å‹ã€å€¼ç­‰å…ƒä¿¡æ¯
  - ç±»ä¼¼å°†å¥å­åˆ†è§£ä¸ºå•è¯çš„è¿‡ç¨‹
- **è¯­æ³•åˆ†æï¼ˆSyntax Analysisï¼‰**
  - æ ¹æ®è¯­æ³•è§„åˆ™å°† Tokens æµè½¬æ¢ä¸ºæ ‘çŠ¶ç»“æ„
  - æ„å»ºå®Œæ•´çš„ AST è¡¨ç¤º
  - ç±»ä¼¼å°†å•è¯ç»„åˆæˆè¯­æ³•æ ‘çš„è¿‡ç¨‹

## 2. è½¬æ¢ â€” Transform

é€šè¿‡ [@babel/traverse](https://www.babeljs.cn/docs/babel-traverse) å¯¹ AST è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†å’Œä¿®æ”¹ï¼š

**éå†æœºåˆ¶**

- é‡‡ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰ç®—æ³•
- è®¿é—®æ¯ä¸ª AST èŠ‚ç‚¹å¹¶æ‰§è¡Œç›¸åº”æ“ä½œ

**è½¬æ¢æ“ä½œ**

- èŠ‚ç‚¹ä¿®æ”¹ï¼šæ›´æ–°èŠ‚ç‚¹å±æ€§
- èŠ‚ç‚¹æ›¿æ¢ï¼šç”¨æ–°èŠ‚ç‚¹æ›¿æ¢ç°æœ‰èŠ‚ç‚¹
- èŠ‚ç‚¹å¢åˆ ï¼šæ’å…¥æˆ–ç§»é™¤èŠ‚ç‚¹

**æ’ä»¶ç³»ç»Ÿ**

- é€šè¿‡é¢„è®¾ï¼ˆPresetsï¼‰å’Œæ’ä»¶ï¼ˆPluginsï¼‰å®šä¹‰è½¬æ¢è§„åˆ™
- æ”¯æŒè‡ªå®šä¹‰è½¬æ¢é€»è¾‘

## 3. ç”Ÿæˆ â€” Generator

ä½¿ç”¨  [@babel/generator](https://www.babeljs.cn/docs/babel-generator)  å°†è½¬æ¢åçš„ AST è¾“å‡ºä¸ºç›®æ ‡ä»£ç ï¼š

**ä»£ç ç”Ÿæˆè¿‡ç¨‹**

- æ·±åº¦ä¼˜å…ˆéå†æœ€ç»ˆ AST
- æ ¹æ®èŠ‚ç‚¹ç±»å‹ç”Ÿæˆå¯¹åº”ä»£ç å­—ç¬¦ä¸²
- å¤„ç†ä»£ç æ ¼å¼ï¼ˆç¼©è¿›ã€åˆ†å·ç­‰ï¼‰

**è¾…åŠ©åŠŸèƒ½**

- ç”Ÿæˆ Source Map æ˜ å°„
- æ”¯æŒä»£ç å‹ç¼©é€‰é¡¹
- ä¿æŒä»£ç å¯è¯»æ€§

**è¾“å‡ºæ§åˆ¶**

- å¯é…ç½®ç”Ÿæˆé€‰é¡¹
- æ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼
- ä¿ç•™æ³¨é‡Šç­‰è¾…åŠ©ä¿¡æ¯

# Babel APIs

æˆ‘ä»¬çŸ¥é“ Babel çš„ç¼–è¯‘æµç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š`Parse` â†’ `Transform` â†’ `Generate`ï¼Œæ¯ä¸€æ­¥éƒ½æš´éœ²äº†ä¸€äº› Api å‡ºæ¥ï¼š

- **è§£æé˜¶æ®µ**ï¼šé€šè¿‡ `@babel/parser` å°†æºç è½¬æˆ ASTï¼›
- **è½¬æ¢é˜¶æ®µ**ï¼šé€šè¿‡ `@babel/traverse` éå†ASTï¼Œå¹¶è°ƒç”¨ `visitor` å‡½æ•°ä¿®æ”¹ ASTï¼ŒæœŸé—´æ¶‰åŠåˆ° AST çš„åˆ¤æ–­ã€åˆ›å»ºã€ä¿®æ”¹ç­‰ï¼Œè¿™æ—¶å€™å°±éœ€è¦ `@babel/types` äº†ï¼Œå½“éœ€è¦æ‰¹é‡åˆ›å»º AST çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ `@babel/template` æ¥ç®€åŒ– AST åˆ›å»ºé€»è¾‘ï¼›
- **ç”Ÿæˆé˜¶æ®µ**ï¼šé€šè¿‡ `@babel/generate` å°† AST è¾“å‡ºä¸ºç›®æ ‡ä»£ç å­—ç¬¦ä¸²ï¼ŒåŒæ—¶ç”Ÿæˆ `sourcemap`ï¼›
- ä¸­é€”é‡åˆ°é”™è¯¯æƒ³æ‰“å°ä»£ç ä½ç½®çš„æ—¶å€™ï¼Œä½¿ç”¨ `@babel/code-frame` åŒ…
- Babel çš„æ•´ä½“åŠŸèƒ½é€šè¿‡ `@babel/core` æä¾›ï¼ŒåŸºäºä¸Šé¢çš„åŒ…å®Œæˆ Babel æ•´ä½“çš„ç¼–è¯‘æµç¨‹ï¼Œå¹¶å®ç°æ’ä»¶åŠŸèƒ½ã€‚

## 1. [`@babel/parser`](https://www.babeljs.cn/docs/babel-parser)

`@babel/parser`ï¼ˆåŸBabylonï¼‰åŸºäº`acorn`å®ç°ï¼Œé€šè¿‡æ’ä»¶ç³»ç»Ÿæ”¯æŒè§£æESNextã€JSXã€Flowã€TypeScriptç­‰è¯­æ³•ï¼Œéœ€æ˜¾å¼å¯ç”¨éæ ‡å‡†è¯­æ³•æ’ä»¶æ‰èƒ½æ­£ç¡®è§£æè¿™äº›ç‰¹æ€§ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

```javascript
// â†’ å¯¼å…¥æ¨¡å—
const parser = require("@babel/parser");

// â†’ å®šä¹‰ä¸€æ®µä»£ç å­—ç¬¦ä¸²
const codeString = `function square(n) {
  return n * n;
}`;

// â†’ è§£æä»£ç 
const ast = parser.parse(codeString, {
  sourceType: "module",
  plugins: ["jsx", "flow"],
});

// â†’ è¾“å‡ºè§£æç»“æœ
console.log(JSON.stringify(ast, null, 4));
```

## 2. [`@babel/traverse`](https://www.babeljs.cn/docs/babel-traverse)

`@babel/traverse` æ˜¯ Babel æä¾›çš„ AST éå†å·¥å…·ï¼Œé‡‡ç”¨è®¿é—®è€…æ¨¡å¼(Visitor Pattern)å®ç°å¯¹ AST èŠ‚ç‚¹çš„ç²¾ç¡®æ“ä½œ

åœ¨éå†è¿‡ç¨‹ä¸­å¯¹ AST èŠ‚ç‚¹è¿›è¡Œå¢åˆ æ”¹ï¼Œéå†ä¸€ä¸ªèŠ‚ç‚¹çš„è¿‡ç¨‹æ˜¯ï¼š`Enter` â†’ `Traverse child node` â†’ `Exit`

è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š

```javascript
require("@babel/traverse").default(ast, visitors)
```

- `ast`ï¼šæŠ½è±¡è¯­æ³•æ ‘AST
- `visitors`ï¼šè®¿é—®è€…

ç¤ºä¾‹ä»£ç ï¼š

```javascript
require("@babel/traverse").default(ast, {
  /** - 1.å±€è¿›å…¥èŠ‚ç‚¹æ—¶è§¦å‘ï¼ˆæ…ç”¨ï¼‰ */
  enter(path) {
    console.log('__enter__');
  },
  /** - 2.å…¨å±€ç¦»å¼€èŠ‚ç‚¹æ—¶è§¦å‘ï¼ˆæ…ç”¨ï¼‰ */
  exit(path) {
    console.log('__exit__');
  },
  /** - 3.ç‰¹å®šèŠ‚ç‚¹ç±»å‹è®¿é—®ï¼šå½“éå†åˆ°æŒ‡å®šèŠ‚ç‚¹ç±»å‹æ—¶è°ƒç”¨ï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ï¼šFunctionDeclarationï¼ˆå‡½æ•°å£°æ˜ï¼‰ï¼ˆå»ºè®®æ–¹æ¡ˆï¼‰ */
  FunctionDeclaration(path) {
    console.log('__FunctionDeclaration__');
  },
  /** - 4.ç²¾ç¡®æ§åˆ¶ï¼šç‰¹å®šèŠ‚ç‚¹ç±»å‹çš„è¿›å…¥/ç¦»å¼€ */
  FunctionDeclaration: {
    enter(path) {
      console.log('__FunctionDeclaration_enter_');
    },
    exit(path) {
      console.log('__FunctionDeclaration_exit_');
    },
  },
  /** - 5.å¤šç±»å‹åŒ¹é…ï¼šä½¿ç”¨|ç¬¦å·ç»„åˆï¼šå½“éå†åˆ° FunctionDeclaration|ReturnStatement èŠ‚ç‚¹æ—¶è°ƒç”¨ */
  /** - è¿™ç§æ–¹å¼ä¼šè¦†ç›–å‰é¢å‡ ç§æ–¹å¼ */
  ['FunctionDeclaration|ReturnStatement'](path) {
    console.log('__FunctionDeclaration|ReturnStatement');
  },
});
```

> **æœ€ä½³å®è·µå»ºè®®**ï¼š
>
> 1. ä¼˜å…ˆä½¿ç”¨ç±»å‹çº§è®¿é—®ï¼Œé¿å…å…¨å±€è®¿é—®å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚
> 2. å¤æ‚åœºæ™¯å¯ä½¿ç”¨ `|` è¯­æ³•ç»„åˆå¤šä¸ªèŠ‚ç‚¹ç±»å‹

å‚æ•° `path`ï¼šè¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´ **è¿æ¥** çš„ **å¯¹è±¡**ï¼ŒåŒ…å«å…³äºè·¯å¾„æ“ä½œå’Œè·¯å¾„ç›¸å…³çš„ä¿¡æ¯ï¼ˆ *åç»­åœ¨æ’ä»¶å¼€å‘å°èŠ‚ç»†è¯´* ï¼‰

## 3. [`@babel/types`](https://www.babeljs.cn/docs/babel-types)

`@babel/types` æ˜¯ Babel ç”Ÿæ€ä¸­ç”¨äº AST èŠ‚ç‚¹æ“ä½œçš„æ ¸å¿ƒå·¥å…·åº“ï¼Œæä¾›èŠ‚ç‚¹åˆ›å»ºã€éªŒè¯å’Œè½¬æ¢ç­‰èƒ½åŠ›ã€‚

æ ¸å¿ƒåŠŸèƒ½ï¼š

- åˆ›å»º AST èŠ‚ç‚¹
- éªŒè¯èŠ‚ç‚¹ç±»å‹
- è½¬æ¢èŠ‚ç‚¹å±æ€§
- æ„å»ºå¤æ‚è¡¨è¾¾å¼

æ¯”å¦‚è¿™é‡Œå°†åˆšåˆšç¤ºä¾‹å‡½æ•°é‡Œé¢çš„æ ‡å¿—ç¬¦ `n` å˜æˆ `x`ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```javascript
// â†’ å¯¼å…¥æ¨¡å—
const parser = require('@babel/parser');
const traverse = require('@babel/traverse');
const t = require('@babel/types');

// â†’ å®šä¹‰ä¸€æ®µä»£ç å­—ç¬¦ä¸²
const codeString = `function square(n) {
  return n * n;
}`;


// â†’ è§£æä»£ç 
const ast = parser.parse(codeString, {
  sourceType: "module",
  plugins: ["jsx", "flow"],
});

// â†’ éå†èŠ‚ç‚¹
traverse.default(ast, {
  Identifier(path) {
    // åˆ¤æ–­æ˜¯å¦æ˜¯ name ä¸º n çš„æ ‡å¿—ç¬¦
    if (t.isIdentifier(path.node, { name: 'n' })) {
      path.node.name = 'x';
    }
  },
});

// â†’ è¾“å‡ºast
console.log(JSON.stringify(ast, null, 4));
```

> **æç¤º**ï¼šå…³äº `@babel/types` çš„æ›´å¤šç”¨æ³•è¯·å‚è€ƒ API.

## 4. [`@babel/generator`](https://www.babeljs.cn/docs/babel-generator)

`@babel/generator` æ˜¯ Babel å·¥å…·é“¾ä¸­çš„ä»£ç ç”Ÿæˆå™¨ï¼Œè´Ÿè´£å°†è½¬æ¢åçš„ AST é‡æ–°ç”Ÿæˆä¸ºå¯æ‰§è¡Œçš„ JavaScript ä»£ç ã€‚

æ ¸å¿ƒåŠŸèƒ½ï¼š

- å°† AST è½¬æ¢ä¸ºæ ‡å‡† JavaScript ä»£ç 
- æ”¯æŒç”Ÿæˆ Source Map
- æä¾›ä»£ç æ ¼å¼åŒ–é€‰é¡¹

ä»£ç ç¤ºä¾‹ï¼š

```javascript
const generator = require('@babel/generator');

// ...

// â†’ å°†ASTè¾“å‡ºä¸ºç›®æ ‡ä»£ç 
const { code, map } = generator(
  ast,
  {
    // ç”Ÿæˆé€‰é¡¹ï¼ˆå¯é€‰ï¼‰
    retainLines: false, // æ˜¯å¦ä¿ç•™åŸå§‹è¡Œå·
    compact: false, // æ˜¯å¦å‹ç¼©ä»£ç 
    comments: true, // æ˜¯å¦ä¿ç•™æ³¨é‡Š
    sourceMaps: false, // æ˜¯å¦ç”Ÿæˆ source map
    // æ›´å¤šé€‰é¡¹...
  },
  codeString // åŸå§‹ä»£ç ï¼ˆç”¨äº source mapï¼‰
);
console.log(code);
/**
 * è¾“å‡ºç»“æœç¤ºä¾‹ï¼š
 * function square(x) {
 *   return x * x;
 * }
 */

```

## 5. [`@babel/core`](https://www.babeljs.cn/docs/babel-core)

`@babel/core` æ˜¯ Babel çš„æ ¸å¿ƒç¼–è¯‘å¼•æ“ï¼Œæ•´åˆäº†å®Œæ•´çš„ç¼–è¯‘æµç¨‹ï¼ˆè§£æ â†’ è½¬æ¢ â†’ ç”Ÿæˆï¼‰ï¼Œæä¾›å¤šç§ç¼–è¯‘æ–¹å¼ã€‚

æ ¸å¿ƒåŠŸèƒ½ï¼š

- å®Œæ•´çš„ä»£ç ç¼–è¯‘æµæ°´çº¿
- åŒæ­¥/å¼‚æ­¥ç¼–è¯‘æ”¯æŒ
- æ–‡ä»¶/ä»£ç /AST å¤šç§è¾“å…¥æ–¹å¼
- è‡ªåŠ¨ç”Ÿæˆ sourcemap

1. åŒæ­¥ç¼–è¯‘

   ```js
   const { transformSync, transformFileSync, transformFromAstSync } = require('@babel/core');
   
   // ä»æºä»£ç ç¼–è¯‘
   const result1 = transformSync('const x = 1;', {
     presets: ['@babel/preset-env'],
     sourceMaps: true
   });
   
   // ä»æ–‡ä»¶ç¼–è¯‘
   const result2 = transformFileSync('input.js', {
     presets: ['@babel/preset-react']
   });
   
   // ä»ASTç¼–è¯‘
   const result3 = transformFromAstSync(parsedAst, sourceCode, {
     plugins: ['@babel/plugin-transform-arrow-functions']
   });
   ```

2. å¼‚æ­¥ç¼–è¯‘

   ```js
   const { transformAsync, transformFileAsync, transformFromAstAsync } = require('@babel/core');
   
   // å¼‚æ­¥ç¼–è¯‘ç¤ºä¾‹
   async function compile() {
     const result = await transformAsync('class A {}', {
       presets: ['@babel/preset-env']
     });
     console.log(result.code);
   }
   ```

3. è¾“å‡ºç»“æœç»“æ„ï¼š

   æ‰€æœ‰ç¼–è¯‘æ–¹æ³•éƒ½è¿”å›åŒ…å«ä»¥ä¸‹å±æ€§çš„å¯¹è±¡ï¼š

   ```js
   {
     code: string,        // ç”Ÿæˆçš„ä»£ç 
     map: object,         // sourcemap
     ast: object,         // æŠ½è±¡è¯­æ³•æ ‘
     metadata: object,    // å…ƒæ•°æ®
     sourceType: string   // æºç ç±»å‹(script/module)
   }
   ```

# åˆæ¢

## 1. åˆ›å»ºç›®å½•

åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„é¡¹ç›®æ–‡ä»¶ç»“æ„ï¼Œå¹¶æ–°å»ºå¿…è¦æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ mkdir -p babel && cd babel && touch app.js
```

> æ³¨æ„ï¼š` package.json` æ–‡ä»¶é€šè¿‡ `npm init -y` æŒ‡ä»¤è‡ªåŠ¨ç”Ÿæˆã€‚

## 2. å®‰è£…ä¾èµ–

```shell
$ npm init -y
$ pnpm add --save-dev @babel/core @babel/cli @babel/preset-env
```

## 3. é…ç½®æ–‡ä»¶

å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼š

- `babel.config.json`ï¼šv7.8.0 ä»¥åï¼ˆå»ºè®®ä½¿ç”¨ï¼‰
- `babel.config.js`ï¼šv7.8.0 ä»¥å‰ï¼ˆæ—§ç‰ˆæœ¬ï¼‰
- `.babelrc`
- `package.json['babel']`

> **æ ¸å¿ƒé…ç½®å‚æ•°**

- `env`ï¼šç¯å¢ƒç‰¹å®šé…ç½®ã€‚
- `plugins`ï¼šæ’ä»¶é›†åˆï¼ˆé¡ºåºæ‰§è¡Œï¼‰ã€‚
- `presets`ï¼šé¢„è®¾é›†åˆï¼ˆé€†åºæ‰§è¡Œï¼‰ã€‚

> **é…ç½®æ–‡ä»¶è§£æè§„åˆ™**

Babel ä¼šä»å½“å‰è½¬è¯‘çš„æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸‹æŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±é¡ºç€æ–‡æ¡£ç›®å½•æ ‘ä¸€å±‚å±‚å¾€ä¸ŠæŸ¥æ‰¾ï¼Œä¸€ç›´åˆ° `.babelrc` æ–‡ä»¶å­˜åœ¨æˆ–è€…å¸¦ `babel` å­—æ®µçš„ `package.json` æ–‡ä»¶å­˜åœ¨ä¸ºæ­¢ã€‚

> **é…ç½®ç¤ºä¾‹**

æ¥ä¸‹æ¥ï¼Œåœ¨æ ¹ç›®å½•ä¸­åˆ›å»º `babel.config.json` é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ°æ­¤æ–‡ä»¶ä¸­ï¼š

```json
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": {
          "browsers": ["> 0.5%", "last 2 versions", "not dead"]
        },
        "useBuiltIns": "usage",
        "corejs": "3.6.5"
      }
    ]
  ]
}
```

> **æ³¨æ„**ï¼šå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Babel çš„æ—§ç‰ˆæœ¬ï¼Œåˆ™æ–‡ä»¶åä¸º `babel.config.js`ã€‚

```js
const presets = [
  [
    "@babel/preset-env",
    {
      targets: {
        browsers: ["> 0.5%", "last 2 versions", "not dead"],
      },
      useBuiltIns: "usage",
      corejs: "3.6.5",
    },
  ],
];

module.exports = { presets };
```

> **æç¤º**ï¼šä¸Šè¿°æµè§ˆå™¨åˆ—è¡¨ï¼ˆ`browsers` é…ç½®é¡¹ï¼‰ä»…ç”¨äºç¤ºä¾‹ã€‚è¯·æ ¹æ®ä½ æ‰€éœ€è¦æ”¯æŒçš„æµè§ˆå™¨è¿›è¡Œè°ƒæ•´ã€‚å‚è§ [æ­¤å¤„](https://www.babeljs.cn/docs/babel-preset-env) ä»¥äº†è§£ `@babel/preset-env` å¯æ¥å—å“ªäº›å‚æ•°ã€‚

## 4. åŸºæœ¬ä½¿ç”¨

é€šè¿‡ä¸Šé¢çš„å‡†å¤‡å·¥ä½œï¼Œæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥ä½¿ç”¨ Babel è¿›è¡Œç¼–è¯‘è½¬æ¢äº†ã€‚åœ¨ `/src/app.js` æ–‡ä»¶ä¸­å†™ä¸€ä¸ªes6çš„ç®­å¤´å‡½æ•°

```javascript
(function () {
  const hello = (name) => {
    console.log(`Hello, ${name}!`);
  };
  hello('Babel');
})();
```

ç„¶åä½¿ç”¨Babelå‘½ä»¤è¡Œå·¥å…·è¿›è¡Œç¼–è¯‘

```shell
# -- ç¼–è¯‘æ–‡ä»¶
$ ./node_modules/.bin/babel app.js --out-file lib/app.js -w -s
# -- ç¼–è¯‘ç›®å½•
$ ./node_modules/.bin/babel src --out-dir lib -w -s
```

è§£è¯»ï¼š

- `-o`ï¼šå°†æŸä¸ªjsæ–‡ä»¶ç¼–è¯‘æˆæŒ‡å®šjsæ–‡ä»¶

- `-d`ï¼šå°†æŸä¸ªç›®å½•ä¸‹çš„jsæ–‡ä»¶ç¼–è¯‘è‡³æŒ‡å®šç›®å½•

- `-w`ï¼šå®æ—¶ç›‘å¬æ–‡ä»¶/è‡ªåŠ¨ç¼–è¯‘

- `-s`ï¼šç”Ÿæˆèµ„æºæ˜ å°„æ–‡ä»¶ä¾¿äºè°ƒè¯•ï¼Œå®ƒå¯ä»¥å¸®åŠ©ä½ åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆç›®å‰åªæœ‰google chromeæµè§ˆå™¨æ”¯æŒè¯¥åŠŸèƒ½ï¼‰çš„â€œSourceâ€é€‰é¡¹å¡ä¸­æ‰¾åˆ°ç¼–è¯‘å‰çš„æºæ–‡ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…è¿›è¡Œè°ƒè¯•ã€‚

  ä½†é¦–å…ˆå¾—ç¡®ä¿ä½ å¼€å‘è€…å·¥å…·çš„è®¾ç½®é‡Œçš„è¿™ä¸€é¡¹æ˜¯å¤„äºå‹¾é€‰çŠ¶æ€ï¼š`å³é”®æ£€æŸ¥` â†’ `å·¥å…·æ ä¸­é€‰æ‹©æ›´å¤š(å³ä¸Šè§’ä¸‰ä¸ªç«–ç€çš„å°åœ†ç‚¹)` â†’  `Setting` â†’  `Sources` â†’  `Enable JavaScript source maps.`

ç»è¿‡ç¼–è¯‘åç”Ÿæˆçš„ `lib/app.js` æ˜¯è¿™æ ·çš„ï¼š

```javascript
(function () {
  var hello = function hello(name) {
    console.log("Hello, ".concat(name, "!"));
  };

  hello('Babel');
})();
```

## 5. å¿«æ·æŒ‡ä»¤

åœ¨ `package.json`  æ–‡ä»¶çš„ `scripts` å±æ€§ä¸‹ï¼Œè®¾ç½®å¦‚ä¸‹ä»£ç ï¼š

```json
"scripts": {
  "dev": "./node_modules/.bin/babel app.js --out-file lib/app.js -w -s"
},
```

> æç¤ºï¼š`dev` è¿™ä¸ªå±æ€§åæ˜¯è‡ªå®šä¹‰çš„ï¼Œå…¶å±æ€§å€¼åˆ™æ˜¯è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚

å†…å®¹é…ç½®å®Œæˆä¹‹åï¼Œåˆ‡æ¢åˆ°å‘½ä»¤è¡Œçª—å£è¾“å…¥ï¼š

 ```shell
$ pnpm dev
 ```

è¿™æ ·å³å¯æ‰§è¡ŒæŒ‡ä»¤è¿›è¡Œç¼–è¯‘ã€‚

# æ’ä»¶å¼€å‘åŸºç¡€

## 1. è¯­æ³•ç»“æ„

Babel æ’ä»¶ä¸»è¦åº”ç”¨åœ¨è½¬æ¢ï¼ˆ`Transform`ï¼‰é˜¶æ®µï¼Œå…¶æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ŒåŸºæœ¬çš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š

```javascript
module.exports = ({ types: t }) => ({
  /** æ’ä»¶åç§° */
  name: 'babel-plugin-name',
  /** è®¿é—®è€…ï¼Œæ’ä»¶æ ¸å¿ƒä»£ç ä¸»è¦åœ¨è¿™é‡Œç¼–è¾‘ */
  visitor: {
    // â†’ è®¿é—®æŒ‡å®šèŠ‚ç‚¹ç±»å‹æ—¶è§¦å‘çš„é’©å­ï¼Œè¿™é‡Œæ˜¯ Identifier ç±»å‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä»»æ„èŠ‚ç‚¹ç±»å‹
    Identifier(path, state) {
      // coding in here...
    },
  },
});
```

ç»“æ„è§£è¯»ï¼š

- `types`ï¼š[@babel/types >>](https://babel.docschina.org/docs/en/babel-types/) å·¥å…·åº“ï¼Œä¸»è¦ç”¨æ¥æ“ä½œASTèŠ‚ç‚¹ï¼Œæ¯”å¦‚åˆ›å»ºã€æ ¡éªŒã€è½¬å˜ç­‰ã€‚
- `name`ï¼šæ’ä»¶åç§°ã€‚
- `visitor`ï¼šBabel é‡‡å–é€’å½’çš„æ–¹å¼è®¿é—®ASTçš„æ¯ä¸ªèŠ‚ç‚¹ã€‚
- `Identifier`ï¼šæ ‡è¯†ç¬¦ï¼ŒèŠ‚ç‚¹ç±»å‹ï¼Œå½“éå†åˆ°ç±»å‹ä¸º `Identifier` æ—¶è¯¥å‡½æ•°ä¼šè¢«è§¦å‘ã€‚
- `path`ï¼šè·¯å¾„ï¼ŒèŠ‚ç‚¹ä¹‹é—´è¿æ¥å¯¹è±¡ï¼ŒåŒ…å«æ“ä½œèŠ‚ç‚¹çš„ä¸€äº›åˆ—å±æ€§å’Œæ–¹æ³•ã€‚
- `state`ï¼šçŠ¶æ€ï¼Œä½ å¯ä»¥é€šè¿‡ `state` è®¿é—®æ’ä»¶çš„é…ç½®é¡¹ã€‚

## 2. `Visitors`ï¼ˆè®¿é—®è€…ï¼‰

å½“æˆ‘ä»¬è°ˆåŠ **è¿›å…¥** ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®é™…ä¸Šæ˜¯è¯´æˆ‘ä»¬åœ¨ **è®¿é—®** å®ƒä»¬ï¼Œ ä¹‹æ‰€ä»¥ä½¿ç”¨è¿™æ ·çš„æœ¯è¯­æ˜¯å› ä¸ºæœ‰ä¸€ä¸ª [**è®¿é—®è€…æ¨¡å¼ï¼ˆVisitorï¼‰>>**](https://en.wikipedia.org/wiki/Visitor_pattern) çš„æ¦‚å¿µã€‚

è®¿é—®è€…æ˜¯ä¸€ä¸ªç”¨äº AST éå†çš„è·¨è¯­è¨€çš„æ¨¡å¼ã€‚ ç®€å•çš„è¯´å®ƒä»¬å°±æ˜¯ä¸€ä¸ª **å¯¹è±¡**ï¼Œå®šä¹‰äº†ç”¨äºåœ¨ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ä¸­è·å–å…·ä½“èŠ‚ç‚¹çš„æ–¹æ³•ã€‚ è¿™ä¹ˆè¯´æœ‰äº›æŠ½è±¡æ‰€ä»¥è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚

```javascript
const visitor = {
  Identifier(path) {
    console.log('Called!');
  },
};
traverse.default(ast, visitor);
```

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è®¿é—®è€…ï¼ŒæŠŠå®ƒç”¨äºéå†ä¸­æ—¶ï¼Œæ¯å½“åœ¨æ ‘ä¸­é‡è§ä¸€ä¸ª `Identifier` çš„æ—¶å€™ä¼šè°ƒç”¨ `Identifier()` æ–¹æ³•ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸€æ®µä»£ç ã€‚

```javascript
function square(n) {
  return n * n;
}
```

è§‚å¯Ÿå…¶ASTç»“æ„ï¼Œ`Identifier` ç±»å‹çš„èŠ‚ç‚¹æœ‰4ä¸ªï¼š

![](./IMGS/ast_visitor.png)

æ‰€ä»¥  `Identifier()` æ–¹æ³•ä¼šè¢«è°ƒç”¨å››æ¬¡ï¼š


```
Called!
Called!
Called!
Called!
```

## 3. `Path`ï¼ˆè·¯å¾„ï¼‰

AST é€šå¸¸ä¼šæœ‰è®¸å¤šèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `path` å¯¹è±¡è¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œæ‰€ä»¥ï¼Œ`path` æ˜¯è¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´è¿æ¥çš„ **å¯¹è±¡**ã€‚é€šè¿‡è¿™ä¸ªå¯¹è±¡æä¾›çš„å±æ€§æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ æ“ä½œ AST è¯­æ³•æ ‘ã€‚

![](./IMGS/babel_path.png)

ä¸Šå›¾ä¸­çº¢è‰²æ–¹æ¡†å¤„è¡¨ç¤ºå¯¹åº”èŠ‚ç‚¹çš„ path ç±»å‹ã€‚

### 2.1. å±æ€§

- `path.state`ï¼šBabel æ’ä»¶ä¿¡æ¯ï¼Œå¯é€šè¿‡ `state.opts` è·å–ä¼ å…¥çš„ Optionsï¼›
- `path.node`ï¼šå½“å‰éå†åˆ°çš„ node èŠ‚ç‚¹ï¼Œå¯é€šè¿‡å®ƒè®¿é—®èŠ‚ç‚¹ä¸Šçš„å±æ€§ï¼Œå¯¹äº Ast èŠ‚ç‚¹ï¼›
- `path.parent`ï¼šçˆ¶çº§ nodeï¼Œæ— æ³•è¿›è¡Œæ›¿æ¢ï¼›
- `path.parentPath`ï¼šçˆ¶çº§ pathï¼Œå¯è¿›è¡Œæ›¿æ¢ï¼›
- `path.scope`ï¼šä½œç”¨åŸŸç›¸å…³ï¼Œå¯ç”¨äºå˜é‡é‡å‘½åï¼Œå˜é‡ç»‘å®šå…³ç³»æ£€æµ‹ç­‰ï¼›
- `path.key`ï¼šè·å–è·¯å¾„æ‰€åœ¨å®¹å™¨çš„ç´¢å¼•
- `path.listKey`ï¼šè·å–å®¹å™¨çš„ `key`
- `path.container`ï¼šè·å–è·¯å¾„çš„å®¹å™¨ï¼ˆåŒ…å«æ‰€æœ‰åŒçº§èŠ‚ç‚¹çš„æ•°ç»„ï¼‰
- `path.inList`ï¼šåˆ¤æ–­è·¯å¾„æ˜¯å¦æœ‰åŒçº§èŠ‚ç‚¹

### 2.2. æ–¹æ³•

- `path.toString()`ï¼šå½“å‰è·¯å¾„æ‰€å¯¹åº”çš„æºä»£ç ï¼›
- `path.isXXX`ï¼š`XXX` ä¸ºèŠ‚ç‚¹ç±»å‹ï¼Œå¯ä»¥åˆ¤æ–­æ˜¯å¦ç¬¦åˆèŠ‚ç‚¹ç±»å‹ã€‚æ¯”å¦‚æˆ‘ä»¬éœ€è¦åˆ¤æ–­è·¯å¾„æ˜¯å¦ä¸º `StringLiteral` ç±»å‹ â†’ `path.isStringLiteral`ï¼›
- `path.get(key)`ï¼šè·å–å­èŠ‚ç‚¹ pathï¼Œä¾‹å¦‚ï¼š`path.get('body.0')` å¯ä»¥ç†è§£ä¸º `path.node.body[0]`è¿™æ ·çš„å½¢å¼ï¼Œè®©æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿çš„æ‹¿åˆ°å­è·¯å¾„ï¼Œä½†æ˜¯æ³¨æ„ä»…è·¯å¾„å¯ä»¥è¿™æ ·æ“ä½œï¼Œè®¿é—®å±æ€§æ˜¯ä¸å…è®¸çš„ï¼
- `path.set(key)`ï¼šè®¾ç½®å­èŠ‚ç‚¹ path;
- `path.remove()`ï¼šåˆ é™¤ path;
- `path.replaceWith()`ï¼šç”¨ASTèŠ‚ç‚¹æ›¿æ¢è¯¥èŠ‚ç‚¹ï¼Œå¦‚ï¼š`path.replaceWith({ type: 'NumericLiteral', value: 3 })`ï¼Œåˆ›å»ºèŠ‚ç‚¹å¯ä»¥ä½¿ç”¨ `@babel/types`ï¼Œå¦‚æœæ˜¯å¤šè·¯å¾„åˆ™ä½¿ç”¨ `relaceWithMultiple([AST...])`;
- `path.replaceWidthSourceString()`ï¼š ç”¨å­—ç¬¦ä¸²æ›¿æ¢æºç 
- `path.find((path) => path.isObjectExpression())` ï¼šå‘ä¸‹æœå¯»èŠ‚ç‚¹
- `path.findParent()`ï¼šå‘çˆ¶èŠ‚ç‚¹æœå¯»èŠ‚ç‚¹
- `path.getSibling()`ã€`path.getNextSibling()`ã€`path.getPrevSibling()`ï¼š è·å–å…„å¼Ÿè·¯å¾„ï¼›
- `path.getFunctionParent()`ï¼š å‘ä¸Šè·å–æœ€è¿‘çš„ Function ç±»å‹èŠ‚ç‚¹ï¼›
- `path.getStatementParent()`ï¼š å‘ä¸Šè·å–æœ€è¿‘çš„ Statement ç±»å‹èŠ‚ç‚¹ï¼›
- `path.insertBefore()`ï¼šåœ¨ä¹‹å‰æ’å…¥å…„å¼ŸèŠ‚ç‚¹
- `path.insertAfter()`ï¼š åœ¨ä¹‹åæ’å…¥å…„å¼ŸèŠ‚ç‚¹
- `path.pushContainer()`ï¼š å°†AST pushåˆ°èŠ‚ç‚¹å±æ€§é‡Œé¢
- `path.traverse()`ï¼š é€’å½’çš„å½¢å¼æ¶ˆé™¤å…¨å±€çŠ¶æ€ï¼ˆ[å®˜ç½‘ >>](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md#toc-state) ä¾‹å­å·²ç»ä¸é”™äº†ï¼‰
- `path.stop()`ï¼š åœæ­¢éå†
- `path.skip()`ï¼š ä¸å¾€ä¸‹éå†ï¼Œè·³è¿‡è¯¥èŠ‚ç‚¹

## 4. `State`ï¼ˆçŠ¶æ€ï¼‰

[çŠ¶æ€ >>](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md#toc-state) æ˜¯æŠ½è±¡è¯­æ³•æ ‘ASTè½¬æ¢çš„æ•Œäººï¼ŒçŠ¶æ€ç®¡ç†ä¼šä¸æ–­ç‰µæ‰¯ä½ çš„ç²¾åŠ›ï¼Œè€Œä¸”å‡ ä¹æ‰€æœ‰ä½ å¯¹çŠ¶æ€çš„å‡è®¾ï¼Œæ€»æ˜¯ä¼šæœ‰ä¸€äº›æœªè€ƒè™‘åˆ°çš„è¯­æ³•æœ€ç»ˆè¯æ˜ä½ çš„å‡è®¾æ˜¯é”™è¯¯çš„ã€‚

è€ƒè™‘ä¸‹åˆ—ä»£ç ï¼š

```javascript
function square(n) {
  return n * n;
}
```

è®©æˆ‘ä»¬å†™ä¸€ä¸ªæŠŠ `n` é‡å‘½åä¸º `x` çš„è®¿é—®è€…çš„å¿«é€Ÿå®ç°.

```javascript
let paramName;
let visitor = {
  FunctionDeclaration(path) {
    const param = path.node.params[0];
    paramName = param.name;
    param.name = 'x';
  },

  Identifier(path) {
    if (path.node.name === paramName) {
      path.node.name = 'x';
    }
  },
}
```

å¯¹äºä¸‹é¢è¿™æ®µä»£ç ï¼š

```javascript
function square(n) {
  return n * n;
}
n;
```

ä¸Šé¢å®šä¹‰çš„è®¿é—®è€… `visitor` ä¹Ÿè®¸èƒ½å·¥ä½œï¼Œä½†å®ƒå¾ˆå®¹æ˜“è¢«æ‰“ç ´ï¼Œæ¯”å¦‚è¿™é‡Œè½¬æ¢ä¹‹åçš„ç»“æœæ˜¯ï¼š

```javascript
function square(n) {
  return n * n;
}
n;
```

å¯ä»¥çœ‹åˆ°ï¼Œå’Œå‡½æ•°åŒçº§åˆ«çš„ `n` ä¹Ÿè¢«è½¬æ¢æˆäº† `x`ï¼Œæ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯ä½¿ç”¨é€’å½’ï¼š

```javascript
const updateParamNameVisitor = {
  Identifier(path) {
    if (path.node.name === this.paramName) {
      path.node.name = 'x';
    }
  },
};
const visitor = {
  FunctionDeclaration(path) {
    const param = path.node.params[0];
    paramName = param.name;
    param.name = 'x';
    path.traverse(updateParamNameVisitor, { paramName });
  },
};
traverse.default(ast, visitor);
```

è¾“å‡ºç»“æœï¼š

```javascript
function square(x) {
  return x * x;
}

n;
```

è¾¾åˆ°é¢„æœŸï¼Œå½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªåˆ»æ„ç¼–å†™çš„ä¾‹å­ï¼Œä¸è¿‡å®ƒæ¼”ç¤ºäº†å¦‚ä½•ä»è®¿é—®è€…ä¸­æ¶ˆé™¤å…¨å±€çŠ¶æ€ã€‚

## 5. `Scope`ï¼ˆä½œç”¨åŸŸï¼‰

 `JavaScript` æ”¯æŒ [è¯æ³•ä½œç”¨åŸŸ ](https://en.wikipedia.org/wiki/Scope_(computer_science)#Lexical_scoping_vs._dynamic_scoping)ï¼Œå½“åˆ›å»ºå¼•ç”¨æ—¶ï¼Œä¸ç®¡æ˜¯é€šè¿‡å˜é‡ã€å‡½æ•°ã€ç±»å‹ã€å‚æ•°ã€æ¨¡å—å¯¼å…¥è¿˜æ˜¯æ ‡ç­¾ç­‰ï¼Œå®ƒéƒ½å±äºå½“å‰ä½œç”¨åŸŸã€‚

```javascript
// global scope
function scopeOne() {
  // scope 1
  function scopeTwo() {
    // scope 2
  }
}
```

1ï¼‰æ›´æ·±çš„å†…éƒ¨ä½œç”¨åŸŸä»£ç å¯ä»¥ä½¿ç”¨å¤–å±‚ä½œç”¨åŸŸä¸­çš„å¼•ç”¨ï¼Œæ¯”å¦‚åœ¨ `scope 2` ä¸­ï¼Œå¯ä»¥è®¿é—® `scope 1` å’Œ `global scope` é‡Œé¢çš„å¼•ç”¨ã€‚

2ï¼‰å†…å±‚ä½œç”¨åŸŸä¹Ÿå¯ä»¥åˆ›å»ºå’Œå¤–å±‚ä½œç”¨åŸŸåŒåçš„å¼•ç”¨ã€‚æ¯”å¦‚åœ¨ `scope 1` ä¸­å®šä¹‰äº†ä¸€ä¸ªå˜é‡ `a`ï¼Œåœ¨ `scope 2` ä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªåŒåçš„å˜é‡ `a`ã€‚

```javascript
function scopeOne() {
  const a = 1;
  const b = 2;
  function scopeTwo() {
    // â†’ è®¿é—®å¤–å±‚ä½œç”¨åŸŸé‡Œé¢çš„å˜é‡
    console.log(a);
    // â†’ åˆ›å»ºç›¸åŒåç§°çš„å˜é‡
    const b = 3;
  }
}
```

å½“ç¼–å†™ä¸€ä¸ªè½¬æ¢æ—¶ï¼Œå¿…é¡»å°å¿ƒä½œç”¨åŸŸã€‚æˆ‘ä»¬å¾—ç¡®ä¿åœ¨æ”¹å˜ä»£ç çš„å„ä¸ªéƒ¨åˆ†æ—¶ä¸ä¼šç ´åå·²ç»å­˜åœ¨çš„ä»£ç ã€‚

ä½œç”¨åŸŸå¯ä»¥è¢«è¡¨ç¤ºä¸ºå¦‚ä¸‹å½¢å¼ï¼š

```js
{
  path: NodePath,
  block: Node,
  parentBlock: Node,
  parent: Scope,
  bindings: { [name: string]: Binding }
}
```

**@Bindingsï¼ˆç»‘å®šï¼‰**

æ‰€æœ‰å¼•ç”¨å±äºç‰¹å®šçš„ä½œç”¨åŸŸï¼Œå¼•ç”¨å’Œä½œç”¨åŸŸçš„è¿™ç§å…³ç³»è¢«ç§°ä½œï¼š**ç»‘å®šï¼ˆbindingï¼‰**ï¼Œé€šè¿‡ `path.scope.bindings` å¯ä»¥æŸ¥çœ‹å˜é‡è¢«ç»‘å®šçš„æƒ…å†µã€‚

ç›¸å…³APIï¼š

- `path.scope.hasBinding("n")` ï¼šæ£€æŸ¥æœ¬åœ° `n` å˜é‡æ˜¯å¦è¢«ç»‘å®šï¼ˆå®šä¹‰ï¼‰ã€‚

- `path.scope.hasOwnBinding("n")` ï¼š æ£€æŸ¥è‡ªèº«ä½œç”¨åŸŸé‡Œé¢æœ‰æ²¡æœ‰ç»‘å®šï¼ˆå®šä¹‰ï¼‰è¿‡ `n` å˜é‡ã€‚

- `path.scope.generateUidIdentifier("uid")`: ç”Ÿæˆä¸€ä¸ªå½“å‰ä½œç”¨åŸŸä¸‹è‚¯å®šä¸å­˜åœ¨çš„å˜é‡åç§°ã€‚

- `path.scope.rename("n", "x")`ï¼šé‡å‘½åå˜é‡ã€‚

- `path.scope.parent.push`ï¼š(èŠ‚ç‚¹) åœ¨çˆ¶ä½œç”¨åŸŸé‡Œé¢æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹

## 7. æ’ä»¶å¼€å‘æµç¨‹ï¼ˆç¯å¢ƒï¼‰

é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸€ä¸ªæ’ä»¶çš„æ—¶å€™å¯ä»¥è¿™æ ·åšï¼š

1ï¼‰åˆ›å»ºå¿…è¦çš„é¡¹ç›®æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼š

```shell
$ mkdir babel-plugin-xxx && cd babel-plugin-xxx && touch index.js && touch __test__.js
```

> - `index.js`ï¼šæ’ä»¶ä»£ç 
> - `__test__.js`ï¼šæµ‹è¯•ä»£ç 

2ï¼‰å®‰è£…ä¾èµ–

```shell
$ npm init -y && npm --save-dev install @babel/core @types/node
```

3ï¼‰ç¼–å†™æ’ä»¶åŸºç¡€ä»£ç 

```javascript
module.exports = ({ types: t }) => ({
  /** æ’ä»¶åç§° */
  name: 'babel-plugin-xxx',
  /** è®¿é—®è€… */
  visitor: {
    // coding in here...
  },
});
```

4ï¼‰ç¼–å†™æµ‹è¯•ä»£ç 

```javascript
// â†’ å¯¼å…¥ transformSync
const { transformSync } = require('@babel/core');

// â†’ ç¼–å†™æµ‹è¯•ä»£ç 
const code = `var a = 10;`;

// â†’ è°ƒç”¨æ’ä»¶å¤„ç†code
const output = transformSync(code, {
  plugins: ['./index.js'],
});

// â†’ è¾“å‡ºç›®æ ‡ä»£ç 
console.log(output.code);
```

4ï¼‰é€šè¿‡nodeè¿è¡Œ

```shell
$ node __test__.js 
```

> **ç‰¹åˆ«æç¤º**ï¼šåœ¨æ’ä»¶å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œä½ åº”è¯¥éšæ—¶æ‰“å¼€ [AST explorer >>](https://astexplorer.net/) æŸ¥çœ‹ä½ è¦å¤„ç†çš„æºä»£ç çš„ AST ç»“æ„ï¼Œè¿™æ ·ä¾¿äºä½ å¤„ç†æ’ä»¶ä¸­çš„é€»è¾‘ã€‚

# æ’ä»¶å¼€å‘å®æˆ˜

## babel-plugin-del-consolelogs

```js
module.exports = ({ types: t }) => {
  return {
    /** æ’ä»¶åç§° */
    name: 'babel-plugin-del-consolelogs',
    /** è®¿é—®è€… */
    visitor: {
      CallExpression(path) {
        // â†’ ç”Ÿäº§ç¯å¢ƒä¸‹æ‰å¤„ç†æ³¨é‡Šæ¸…é™¤
        if (process.env.NODE_ENV === 'production') {
          // â†’ è·å–çˆ¶çº§ASTèŠ‚ç‚¹
          const parentNode = path.parent;
          // â†’ ç­›é€‰æ˜¯å¦æ˜¯æ‰“å°è¯­å¥
          const isConsoleStatement = t.isIdentifier(path.node.callee.object, {
            name: 'console',
          });
          // â†’ å®šä¹‰å˜é‡ï¼Œè®°å½•æ˜¯å¦æ‰§è¡Œæ¸…é™¤åŠ¨ä½œï¼Œé»˜è®¤ä¸ºtrue
          let shouldRemove = true;
          // â†’ åˆ¤æ–­æ˜¯å¦æ˜¯conosleè¯­å¥
          if (isConsoleStatement) {
            // â†’ éå†å‰ç½®æ³¨é‡Š
            if (parentNode.leadingComments) {
              parentNode.leadingComments.forEach((comment) => {
                // åˆ¤æ–­æ³¨é‡Šå†…å®¹æ˜¯å¦æ˜¯ä¿ç•™æ³¨é‡Šï¼š@lg-noremove
                if (comment.value.trim() === '@lg-noremove') {
                  shouldRemove = false;
                }
              });
            }
            // â†’ éå†åç½®æ³¨é‡Š
            if (parentNode.trailingComments) {
              // è·å–consoleæ‰€åœ¨è¡Œ
              const consoleLine = parentNode.expression.loc.start.line;
              parentNode.trailingComments.forEach((comment) => {
                // è¯»å–æ³¨é‡Šæ‰€åœ¨è¡Œ
                const commentLine = comment.loc.start.line;
                // åˆ¤æ–­æ³¨é‡Šå†…å®¹æ˜¯å¦æ˜¯ä¿ç•™æ³¨é‡Šï¼š@lg-noremove å¹¶ä¸”æ˜¯å¦å’Œconsoleè¯­å¥åœ¨åŒä¸€è¡Œ
                if (
                  comment.value.trim() === '@lg-noremove' &&
                  consoleLine === commentLine
                ) {
                  shouldRemove = false;
                }
              });
            }
            // â†’ ç§»é™¤
            if (shouldRemove) {
              path.remove();
            }
          }
        }
      },
    },
  };
};
```
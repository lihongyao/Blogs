

# æ¦‚è¿°

## 1. æ˜¯ä»€ä¹ˆï¼Ÿ

[Rollup >>](https://cn.rollupjs.org/) æ˜¯ä¸€ä¸ªç”¨äº JavaScript çš„æ¨¡å—æ‰“åŒ…å·¥å…·ï¼Œæ—¨åœ¨é€šè¿‡ä¼˜åŒ–æ‰“åŒ…è¿‡ç¨‹ï¼Œæé«˜ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚ä¸ Webpack ç­‰å·¥å…·ç›¸æ¯”ï¼ŒRollup ç‰¹åˆ«é€‚åˆç”¨äºæ‰“åŒ…å·¥å…·åº“ã€ç»„ä»¶åº“ä»¥åŠå•ä¸€ç”¨é€”çš„æ¨¡å—ï¼Œç‰¹åˆ«æ˜¯åœ¨æ”¯æŒ ES6 æ¨¡å—æ—¶ï¼ŒRollup å¯ä»¥åšåˆ°æ›´é«˜æ•ˆçš„ Tree Shaking å’Œæ›´å°çš„è¾“å‡ºä½“ç§¯ã€‚

## 2. æœ‰ä½•ä¼˜åŠ¿ï¼Ÿ

Rollup æ ¸å¿ƒä¼˜åŠ¿ä½“ç°åœ¨ï¼š

1. **Tree Shaking ä¼˜åŒ–**

   Rollup é€šè¿‡ **é™æ€åˆ†æ** ES6 æ¨¡å—çš„å¯¼å…¥å¯¼å‡ºå…³ç³»ï¼Œè‡ªåŠ¨å‰”é™¤æœªä½¿ç”¨çš„ä»£ç ï¼ˆå¦‚æœªè°ƒç”¨çš„å‡½æ•°æˆ–å˜é‡ï¼‰ï¼Œç”Ÿæˆæ›´ç²¾ç®€çš„æ‰“åŒ…æ–‡ä»¶ã€‚

2. **å¤šæ ¼å¼è¾“å‡ºæ”¯æŒ**

   æ”¯æŒè¾“å‡º `ESM`ã€`CommonJS`ã€`UMD` ç­‰æ¨¡å—æ ¼å¼ï¼Œé€‚åˆåº“å¼€å‘å’Œè·¨ç¯å¢ƒå…¼å®¹ã€‚

3. **æ’ä»¶ç”Ÿæ€**

   æä¾›ä¸°å¯Œçš„æ’ä»¶

4. **ä¸“æ³¨åº“å¼€å‘çš„ä¼˜åŒ–è®¾**

   - åŸç”Ÿæ”¯æŒä»£ç åˆ†å‰²ï¼ˆCode Splittingï¼‰å’ŒæŒ‰éœ€åŠ è½½ã€‚
   - é€šè¿‡æ’ä»¶ç³»ç»Ÿï¼ˆå¦‚ @rollup/plugin-node-resolveï¼‰å®ç°çµæ´»çš„ä¾èµ–è§£æã€‚
   - æ„å»ºé€Ÿåº¦æ¯” Webpack å¿« 2-3 å€ï¼Œç‰¹åˆ«é€‚åˆ Monorepo é¡¹ç›®ã€‚

## 3. Rollup vs. Webpack

Rollup å’Œ Webpack çš„åŒºåˆ«ï¼Œç®€å•æ¥è¯´ï¼š

1. **Tree Shaking**
   - Rollup é‡‡ç”¨åŸºäº ES Modules çš„ **é™æ€åˆ†æ**ï¼ˆå³åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šæ¨¡å—çš„ä¾èµ–å…³ç³»ï¼‰ï¼Œæ¸…é™¤æ›´æµ‹åº•ã€‚
   - Webpack é‡‡ç”¨ **åŠ¨æ€åˆ†æ**ï¼ˆå³åœ¨è¿è¡Œæ—¶æ ¹æ®æ¨¡å—åŠ è½½çš„æƒ…å†µæ¥ç¡®å®šä¾èµ–å…³ç³»ï¼‰ï¼Œæ”¯æŒåŠ¨æ€ç­‰é«˜çº§ç‰¹æ€§ï¼Œéœ€ é…åˆ package.json çš„ sideEffects æ ‡è®°ä¼˜åŒ–ã€‚
2. **è¾“å‡ºä½“ç§¯**
   - Rollup è¾“å‡ºä½“ç§¯æ›´å°
   - Webpack è¾“å‡ºä½“ç§¯è¾ƒå¤§ï¼ˆå«è¿è¡Œæ—¶ä»£ç ï¼‰
3. **é€‚ç”¨åœºæ™¯**
   - Rollup é€‚åˆåº“å¼€å‘
   - Webpack é€‚åˆéœ€è¦å¤æ‚åŠŸèƒ½ï¼ˆå¦‚ä»£ç åˆ†å‰²ã€çƒ­æ›´æ–°ï¼‰çš„åº”ç”¨åœºæ™¯
4. **ç”Ÿæ€æ‰©å±•æ€§**
   - Webpack æ‹¥æœ‰æ›´å®Œå–„çš„æ’ä»¶ä½“ç³»
   - Rollup çš„æ’ä»¶ç³»ç»Ÿæ›´è½»é‡ä½†åŠŸèƒ½å®Œæ•´

ä¸€å¥è¯æ¦‚æ‹¬ï¼š

- Rollup = **å°è€Œç²¾**ï¼Œä¸“ä¸ºåº“ä¼˜åŒ–

- Webpack = **å¤§è€Œå…¨**ï¼Œé€‚åˆå¤æ‚åº”ç”¨

> æŠ€æœ¯é€‰å‹å»ºè®®ï¼š
>
> å¯¹äºåº“å¼€å‘è€…ï¼Œå»ºè®®é‡‡ç”¨ Rollup ä½œä¸ºä¸»è¦æ„å»ºå·¥å…·ï¼›å¯¹äºåº”ç”¨å¼€å‘è€…ï¼ŒWebpack ä»æ˜¯æ›´å…¨é¢çš„é€‰æ‹©ã€‚åœ¨ç°ä»£åŒ–æ„å»ºæ–¹æ¡ˆä¸­ï¼ŒVite ç­‰å·¥å…·å·²ç»å®ç°äº†ä¸¤è€…çš„ä¼˜åŠ¿äº’è¡¥ã€‚

> **æç¤º**ï¼š
>
> - å¦‚æœä½ æƒ³äº†è§£ä¸»æµæ‰“åŒ…å·¥å…·å¯¹æ¯”æŠ¥å‘Šï¼Œè¯·å‚è€ƒ  [è¿™é‡Œ >>](https://bundlers.tooling.report/)
>
> - Rollup æä¾›äº†ä¸€ä¸ªæ¼”ç¤ºæ‰“åŒ…ç»“æœçš„ [åœ¨çº¿æ¼”ç»ƒåœº >>](https://cn.rollupjs.org/repl/)ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å»è¯•è¯•ã€‚

# é…ç½®æ–‡ä»¶

**`rollup.config.js`**

```js
import { defineConfig } from 'rollup';

export default defineConfig({
  input,     // å…¥å£é…ç½®ï¼ˆå¿…éœ€ï¼‰
  output,    // è¾“å‡ºé…ç½®ï¼ˆå¿…éœ€ï¼‰ 
  plugins,   // æ’ä»¶ç³»ç»Ÿ
  external,  // å¤–éƒ¨ä¾èµ–
  watch,     // ç›‘å¬æ¨¡å¼
  cache      // æ„å»ºç¼“å­˜
});
```

> æç¤ºï¼šæœ‰å…³æ¯ä¸ªé€‰é¡¹çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [é€‰é¡¹å¤§å…¨ >>](https://cn.rollupjs.org/configuration-options/)

# å¸¸ç”¨Plugins

- [rollup](https://www.npmjs.com/package/rollup)ï¼šæ ¸å¿ƒåº“
- [cross-env](https://www.npmjs.com/package/cross-env)ï¼šè·¨ç¯å¢ƒè®¾ç½®ç¯å¢ƒå˜é‡
- [@rollup/plugin-commonjs](https://www.npmjs.com/package/@rollup/plugin-commonjs)ï¼šå°†CommonJSè½¬ä¸ºESæ¨¡å—
- [@rollup/plugin-json](https://www.npmjs.com/package/@rollup/plugin-json)ï¼šæ”¯æŒç›´æ¥å¯¼å…¥JSONæ–‡ä»¶
- [@rollup/plugin-node-resolve](https://www.npmjs.com/package/@rollup/plugin-node-resolve)ï¼šè§£æç¬¬ä¸‰æ–¹æ¨¡å—ä¾èµ– â€”â€” *(!) Unresolved dependencies*



- [@rollup/plugin-eslint](https://www.npmjs.com/package/@rollup/plugin-eslint)ï¼šä»£ç è´¨é‡æ£€æŸ¥
- [rollup-plugin-filesize](https://www.npmjs.com/package/rollup-plugin-filesize)ï¼šæ˜¾ç¤ºæ‰“åŒ…ä½“ç§¯
- [rollup-plugin-delete](https://www.npmjs.com/package/rollup-plugin-delete)ï¼šæ„å»ºå‰æ¸…ç†ç›®å½•
- [rollup-plugin-progress](https://github.com/jkuri/rollup-plugin-progress)ï¼šæ˜¾ç¤ºæ„å»ºè¿›åº¦æ¡
- [rollup-plugin-serve](https://github.com/thgh/rollup-plugin-serve)ï¼šå¼€å‘æœåŠ¡å™¨

- [@rollup/plugin-alias](https://www.npmjs.com/package/@rollup/plugin-alias)ï¼šè·¯å¾„åˆ«å

- [@rollup/plugin-terser](https://www.npmjs.com/package/@rollup/plugin-terser)ï¼šä»£ç å‹ç¼©

- [@rollup/plugin-replace](https://www.npmjs.com/package/@rollup/plugin-replace)ï¼šåœ¨ Rollup æ‰“åŒ…è¿‡ç¨‹ä¸­æ›¿æ¢ä»£ç ä¸­çš„å­—ç¬¦ä¸²æˆ–è¡¨è¾¾å¼ï¼ˆå¦‚ç¯å¢ƒå˜é‡ã€é…ç½®å‚æ•°ç­‰ï¼‰

- [rollup-plugin-delete](https://www.npmjs.com/package/rollup-plugin-delete)ï¼šæ¯æ¬¡æ‰“åŒ…ä¹‹å‰æ¸…é™¤è¾“å‡ºç›®å½•ï¼ˆdelï¼‰

- [rollup-plugin-generate-package-json](https://www.npmjs.com/package/rollup-plugin-generate-package-json)ï¼šç”Ÿæˆ package.json æ–‡ä»¶

- [rollup-plugin-visualizer](https://github.com/btd/rollup-plugin-visualizer)ï¼šå¯è§†åŒ–åˆ†æåŒ…å†…å®¹

- [rollup-plugin-bundle-analyzer](https://github.com/doesdev/rollup-plugin-analyzer)ï¼šåŒ…ä½“ç§¯åˆ†æ

  

- [@rollup/plugin-babel](https://www.npmjs.com/package/@rollup/plugin-babel)ï¼šç”¨äºä½¿ç”¨ Babel è¿›è¡Œè½¬è¯‘

- [@babel/core](https://www.npmjs.com/package/@babel/core)ï¼šBabel æ ¸å¿ƒåº“

- [@babel/preset-env](https://www.npmjs.com/package/@babel/preset-env)ï¼šBabel é¢„è®¾é…ç½®

- [core-js](https://www.npmjs.com/package/core-js)ï¼špolyfillsï¼Œä»Babel 7.4.0å¼€å§‹ï¼Œæ¨èç›´æ¥å®‰è£… **`core-js`** å³å¯ï¼Œå¤„ç†Promiseç­‰è¯­æ³•

- [@rollup/plugin-typescript](https://www.npmjs.com/package/@rollup/plugin-typescript)ï¼šç”¨äºå°† TypeScript æ–‡ä»¶ç¼–è¯‘ä¸º JavaScript

- [@babel/preset-typescript](https://www.npmjs.com/package/@babel/preset-typescript)ï¼šTypeScript é¢„è®¾é…ç½®

- [tslib](https://www.npmjs.com/package/tslib)ï¼šTypeScript ç¼–è¯‘åçš„ js ä»£ç çš„è¿è¡Œæ—¶åº“

> **æ’ä»¶é€‰æ‹©å»ºè®®**ï¼š
>
> 1. ä¼˜å…ˆä½¿ç”¨Rollupå®˜æ–¹ç»´æŠ¤çš„ `@rollup/plugin-*` ç³»åˆ—
> 2. å¤æ‚é¡¹ç›®å»ºè®®é…åˆ`unplugin` ç»Ÿä¸€æ’ä»¶ç³»ç»Ÿ
> 3. æ³¨æ„æ’ä»¶é¡ºåºï¼šresolve â†’ commonjs â†’ babel â†’ terser
> 4. å¸¸ç”¨æ’ä»¶åˆ—è¡¨å‚è€ƒï¼š[ç‚¹å‡»å‰å¾€ >>](https://github.com/rollup/awesome)
> 5. æ¨èé˜…è¯»ï¼š[ä¸€æ–‡å…¥é—¨rollupğŸª€ï¼13ç»„demoå¸¦ä½ è½»æ¾é©¾é©­](https://juejin.cn/post/7069555431303020580)

# å®æˆ˜

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»¥å®æ“çš„å½¢å¼æ‰‹æŠŠæ‰‹å¸¦ç€å¤§å®¶åŸºäºrollup å°è£…å¹¶å‘å¸ƒä¸€ä¸ª js åº“ã€‚

## 1. åˆ›å»ºç›®å½•ç»“æ„

```shell
$ mkdir -p rollup-examples/src && cd rollup-examples && touch src/index.ts && pnpm init && code . 
```

ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```
rollup-examples
.
â”œâ”€â”€ src
â”‚	â””â”€â”€	 index.ts
â””â”€â”€ package.json
```

> æç¤ºï¼š
>
> - é¡¹ç›®å **`rollup-examples`** æ ¹æ®éœ€è¦ä¿®æ”¹ã€‚
> - åŒ…ç®¡ç†å·¥å…·ä½¿ç”¨ **`pnpm`**ï¼Œè‡³äºä¸ºä»€ä¹ˆä½¿ç”¨å®ƒï¼Œæ¨èé˜…è¯» [å‰ç«¯åŒ…ç®¡ç†å·¥å…·æ¼”è¿›å²ï¼šä» npm åˆ° pnpm çš„æŠ€æœ¯é©æ–° >>](https://juejin.cn/post/7487783643920187428)

## 2. å®šä¹‰å¼€å‘è§„èŒƒ

### ä»£ç è§„èŒƒæ£€æŸ¥ä¸ä¿®å¤

ä½¿ç”¨å·¥å…·ï¼š[ESLint](https://eslint.nodejs.cn/)

1ï¸âƒ£ å®‰è£… & é…ç½® ESLint

```shell
$ pnpm create @eslint/config@latest

? How would you like to use ESLint? â€¦ 
  To check syntax only
â¯ To check syntax and find problems

? What type of modules does your project use? â€¦ 
â¯ JavaScript modules (import/export)
  CommonJS (require/exports)
  None of these
  
? Which framework does your project use? â€¦ 
  React
  Vue.js
â¯ None of these

? Does your project use TypeScript? â€¦ 
  No
â¯ Yes

? Where does your code run? â€¦  (Press <space> to select, <a> to toggle all, <i> to invert selection)
âœ” Browser
  Node

eslint, globals, @eslint/js, typescript-eslint
? Would you like to install them now? â€º No / [Yes]

? Which package manager do you want to use? â€¦ 
  npm
  yarn
â¯ pnpm
  bun
```

ä¸Šè¿°æ“ä½œï¼Œå°†åœ¨æ ¹ç›®å½•ç”Ÿæˆ **`eslint.config.mjs`** é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```js
import { defineConfig } from 'eslint/config'
import globals from 'globals'
import js from '@eslint/js'
import tseslint from 'typescript-eslint'

export default defineConfig([
  { files: ['**/*.{js,mjs,cjs,ts}'] },
  { files: ['**/*.{js,mjs,cjs,ts}'], languageOptions: { globals: globals.browser } },
  { files: ['**/*.{js,mjs,cjs,ts}'], plugins: { js }, extends: ['js/recommended'] },
  { ignores: ['node_modules/', 'dist/', 'build/', '**/*.test.js'] },
  tseslint.configs.recommended,
  {
    env: { node: true },
    rules: {
      // TODOï¼šä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä½ è‡ªå·±çš„è§„åˆ™
    },
  },
])
```

> **æç¤º**ï¼šESLint è§„åˆ™å‚è€ƒï¼Œç‚¹å‡» [è¿™é‡Œ >> ](https://eslint.nodejs.cn/docs/latest/rules/)

2ï¸âƒ£ è®¾ç½®æŒ‡ä»¤ **`package.json`**

```
{
  "scripts": {
    "lint": "eslint --fix --quiet ."
  }
}
```

- `--fix`ï¼šè‡ªåŠ¨ä¿®å¤å¯ä¿®å¤çš„ä»£ç é—®é¢˜ï¼ˆå¦‚ç¼©è¿›ã€å¼•å·ç­‰æ ¼å¼é—®é¢˜ï¼‰
- `--quiet`ï¼šä»…æŠ¥å‘Šé”™è¯¯ï¼ˆerrorï¼‰ï¼Œå¿½ç•¥è­¦å‘Šï¼ˆwarningï¼‰
- `.`ï¼šæ£€æŸ¥å½“å‰ç›®å½•åŠå­ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆéœ€é…åˆ`--ext`æŒ‡å®šæ–‡ä»¶ç±»å‹ï¼‰

### ä»£ç é£æ ¼ 

ä½¿ç”¨å·¥å…·ï¼š[Prettier](https://prettier.nodejs.cn/)

1ï¸âƒ£ å®‰è£…

```shell
$ pnpm add --save-dev --save-exact prettier
```

2ï¸âƒ£ åˆ›å»ºé…ç½®æ–‡ä»¶

```shell
$ node --eval "fs.writeFileSync('.prettierrc','{}\n')"
```
```j'sojson
{
  "printWidth": 120,
  "tabWidth": 2,
  "semi": false,
  "singleQuote": true,
  "jsxSingleQuote": false,
  "trailingComma": "all",
  "bracketSpacing": true,
  "objectWrap": "preserve",
  "bracketSameLine": true,
  "arrowParens": "avoid",
  "proseWrap": "always",
  "htmlWhitespaceSensitivity": "css",
  "vueIndentScriptAndStyle": false,
  "endOfLine": "lf",
  "singleAttributePerLine": false
}
```

> **æç¤º**ï¼šå®Œæ•´é…ç½®å‚è€ƒ [Prettier å®˜æ–¹æ–‡æ¡£ ğŸ”—](https://prettier.nodejs.cn/docs/options)

3ï¸âƒ£ åˆ›å»ºå¿½ç•¥æ–‡ä»¶ï¼š

```shell
$ node --eval "fs.writeFileSync('.prettierignore','# Ignore artifacts:\nbuild\ncoverage\n')"
```

4ï¸âƒ£ é›†æˆåˆ°ç¼–è¾‘å™¨ï¼ˆVSCodeï¼‰

å®‰è£…æ‰©å±•ï¼š[Prettier - Code formatter](https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode)

é…ç½®ç¼–è¾‘ï¼š

- æœç´¢  ***Editor:Default formatter***ï¼Œå°†å€¼è®¾ç½®ä¸º ***Prettier - Code formatter***
- æœç´¢ ***Editor:Format On Save***ï¼Œâ˜‘ï¸ åœ¨ä¿å­˜æ—¶æ ¼å¼åŒ–æ–‡ä»¶ã€‚

5ï¸âƒ£ ä¸ ESLint é…åˆï¼šä½¿ç”¨ [eslint-config-prettier](https://github.com/prettier/eslint-config-prettier) æ’ä»¶å…³é—­ä¸ Prettier å†²çªçš„ ESLint è§„åˆ™

```shell
$ pnpm add -D eslint-config-prettier
```

> **`eslint.config.mjs`**

```js
import eslintConfigPrettier from 'eslint-config-prettier'

export default defineConfig([
  ...
  eslintConfigPrettier,
])
```

### Git è§„èŒƒæ£€æŸ¥

ä½¿ç”¨å·¥å…·ï¼š [`commitlint`](https://commitlint.js.org/) + [`husky`](https://typicode.github.io/husky/) + `lint-staged` 

1ï¸âƒ£  åˆ›å»º git ä»“åº“ï¼Œç„¶ååœ¨æ ¹ç›®å½•åˆ›å»ºå¿½ç•¥æ–‡ä»¶ `.gitignore`

```shell
$ git init 
```

```ini
# .gitignore

node_modules
dist
build
*.local

logs
*.log


.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
```

2ï¸âƒ£ å®‰è£…ä¾èµ–

```shell
$ pnpm add husky lint-staged @commitlint/{cli,config-conventional} -D
```

- `husky`ï¼šGité’©å­ç®¡ç†ï¼ˆéœ€Node.js v18+ï¼‰
- `commitlint`ï¼šæäº¤ä¿¡æ¯è§„èŒƒæ ¡éªŒï¼ˆæ¨è`@commitlint/config-conventional`è§„åˆ™ï¼‰
- `lint-staged`ï¼šä»…æ£€æŸ¥æš‚å­˜åŒºæ–‡ä»¶

4ï¸âƒ£ åˆå§‹åŒ– husky

è‡ªåŠ¨åˆ›å»º `.husky` ç›®å½•å¹¶è®¾ç½® Git Hook

```shell
$ pnpm exec husky init
```

5ï¸âƒ£ é…ç½® `pre-commit` é’©å­

é…ç½® `pre-commit` é’©å­ï¼Œåœ¨æäº¤æ—¶è¿è¡Œ `lint-staged`ï¼Œåªæ£€æŸ¥æš‚å­˜åŒºçš„æ–‡ä»¶ï¼š

```shell
$ echo "npx lint-staged" > .husky/pre-commit && chmod +x .husky/pre-commit
```

åœ¨ `package.json` ä¸­é…ç½® `lint-staged`ï¼š

```
"lint-staged": {
  "*.{js,jsx,ts,tsx}": [
    "prettier --write --cache",
    "eslint --fix --quiet"
  ]
},
```

è¿™æ ·ï¼Œå½“ä½ æ‰§è¡Œ `git commit` æ—¶ï¼Œ`lint-staged` ä¼šè‡ªåŠ¨è¿è¡Œ `pnpm lint` æ¥æ£€æŸ¥æš‚å­˜åŒºä¸­çš„æ–‡ä»¶ã€‚

6ï¸âƒ£ é…ç½® `commit-msg` é’©å­

é…ç½® `commit-msg` é’©å­ï¼Œæ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦ç¬¦åˆè§„èŒƒï¼š

```shell
$ echo "npx --no-install commitlint --edit \$1" > .husky/commit-msg && chmod +x .husky/commit-msg
```

åˆ›å»º `commitlint.config.js` æ–‡ä»¶æ¥é…ç½® `commitlint`ï¼š

```js
echo "export default { extends: ['@commitlint/config-conventional'] };" > commitlint.config.js
```

> æç¤ºï¼šåœ¨ package.json æ–‡ä»¶ä¸­è®¾ç½® `"type": "module"`

<hr />

ç°åœ¨ï¼Œå½“ä½ æ‰§è¡Œ `git commit` æ—¶ï¼Œ`husky` ä¼šè‡ªåŠ¨è§¦å‘ä»¥ä¸‹é’©å­ï¼š

- **`pre-commit` é’©å­**ï¼šè¿è¡Œ `lint-staged`ï¼Œå¯¹æš‚å­˜åŒºçš„æ–‡ä»¶è¿›è¡Œä»£ç é£æ ¼æ£€æŸ¥ã€‚
- **`commit-msg` é’©å­**ï¼šè¿è¡Œ `commitlint`ï¼Œæ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦ç¬¦åˆè§„èŒƒã€‚

è¿™æ ·é…ç½®åï¼Œä½ çš„é¡¹ç›®å°†èƒ½å¤Ÿåœ¨æäº¤æ—¶è‡ªåŠ¨è¿›è¡Œä»£ç é£æ ¼å’Œæäº¤ä¿¡æ¯çš„æ£€æŸ¥ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œæäº¤ä¿¡æ¯çš„è§„èŒƒæ€§ã€‚

æ³¨æ„ï¼š

1. `lint-staged` ä¼šè‡ªåŠ¨å°†ä¿®æ”¹åçš„æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒºï¼Œå› æ­¤ä¸è¦åœ¨ `lint-staged` é…ç½®ä¸­æ˜¾å¼è°ƒç”¨ `git add`ã€‚
2. å¦‚æœ `pnpm lint` æ£€æŸ¥å¤±è´¥ï¼Œæäº¤ä¼šè¢«é˜»æ­¢ã€‚è¯·æ ¹æ®é”™è¯¯æç¤ºä¿®å¤ä»£ç åé‡æ–°æäº¤ã€‚
3. å¦‚æœéœ€è¦è‡ªå®šä¹‰æäº¤ä¿¡æ¯è§„èŒƒï¼Œå¯ä»¥ä¿®æ”¹ `commitlint.config.js` æ–‡ä»¶ï¼Œæ·»åŠ è‡ªå®šä¹‰è§„åˆ™ã€‚

ğŸ“– æ‰©å±•ï¼š`conventional`  è§„èŒƒ

æ ¼å¼ï¼š

```
<type>: <subject> â†’ æäº¤çš„ç±»å‹: æ‘˜è¦ä¿¡æ¯
```

å¸¸ç”¨çš„ `type` å€¼åŒ…æ‹¬å¦‚ä¸‹:

- featï¼šæ·»åŠ æ–°åŠŸèƒ½
- fixï¼šä¿®å¤ Bug
- choreï¼šä¸€äº›ä¸å½±å“åŠŸèƒ½çš„æ›´æ”¹
- docsï¼šä¸“æŒ‡æ–‡æ¡£çš„ä¿®æ”¹
- perfï¼šæ€§èƒ½æ–¹é¢çš„ä¼˜åŒ–
- refactorï¼šä»£ç é‡æ„
- testï¼šæ·»åŠ ä¸€äº›æµ‹è¯•ä»£ç ç­‰ç­‰

æäº¤æ—¶çš„ä»£ç æ ¼å¼ï¼š*`git commit -m "feat: xxx"`*

> æ³¨æ„ï¼š`feat: ` åé¢è·Ÿä¸€ä¸ªç©ºæ ¼ã€‚

### é…ç½® `tsconfig.json`

```json
{
  "compileOnSave": true,
  "compilerOptions": {
    "target": "ESNext",
    "module": "ESNext",
    "lib": ["ESNext", "DOM", "DOM.Iterable"],
    "strict": true,
    "esModuleInterop": true,
    "useDefineForClassFields": true,

    "moduleResolution": "Node",
    "resolveJsonModule": true,
    "noEmit": true,

    "baseUrl": "./",
    "paths": {
      "@/*": ["src/*"]
    },

    "declaration": true,
    "declarationDir": "dist",

    "sourceMap": true,
    "isolatedModules": true,

    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": false,
    "skipLibCheck": true
  },
  "include": ["src/**/*", "dist"],
  "exclude": ["node_modules", "dist"]
}
```

## 3. å®‰è£…ä¾èµ–

```shell
$ pnpm add cross-env rollup @rollup/plugin-commonjs @rollup/plugin-node-resolve @rollup/plugin-babel @babel/core @babel/preset-env core-js @rollup/plugin-typescript @babel/preset-typescript tslib @rollup/plugin-alias @rollup/plugin-eslint @rollup/plugin-alias rollup-plugin-delete @rollup/plugin-terser rollup-plugin-generate-package-json -D
```

## 4. é…ç½®

### **`package.json`**

```json
{
  "name": "<rollup-examples>",
  "version": "1.0.0",
  "description": "<A modern TypeScript library built with Rollup>",
  "type": "module",
  "main": "./dist/index.cjs.js",
  "module": "./dist/index.esm.js",
  "types": "./dist/index.d.ts",
  "exports": {
    "import": "./dist/index.esm.js",
    "require": "./dist/index.cjs.js",
    "types": "./dist/index.d.ts"
  },
  "files": [
    "dist/**/*",
    "README.md"
  ],
  "scripts": {
    "lint": "eslint --fix --quiet .",
    "prepare": "husky",
    "build:dev": "cross-env NODE_ENV=development rollup --config rollup.config.mjs --bundleConfigAsCjs",
    "build:pro": "cross-env NODE_ENV=production rollup --config rollup.config.mjs --bundleConfigAsCjs"
  },
  "buildOptions": {
    "formats": [
      "iife",
      "cjs",
      "umd",
      "esm"
    ],
    "name": "<module-name"
  },
  "keywords": [
    "typescript",
    "rollup",
    "library"
  ],
  "author": "<Your Name <your.email@example.com>>",
  "license": "ISC",
  "repository": {
    "type": "git",
    "url": "https://github.com/<username>/<rollup-examples>.git"
  },
  "bugs": {
    "url": "https://github.com/<username>/<rollup-examples>/issues"
  },
  "homepage": "https://github.com/<username>/<rollup-examples>#readme",
  "devDependencies": {
    ...
  }
}

```

> **æ³¨æ„**ï¼šä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ`name`ã€`description`ã€`buildOptions.name`ã€`keywords`ã€`author`ã€`repository`ã€`bugs` ä»¥åŠ `homepage` ç­‰å­—æ®µè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ã€‚

å­—æ®µç®€ä»‹ï¼š

- `name`ï¼šåŒ…åï¼Œå”¯ä¸€æ ‡è¯†ï¼Œç”±å°å†™è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸èƒ½åŒ…å«ç©ºæ ¼*ï¼ˆå¿…å¡«é¡¹ï¼‰*
- `version`ï¼šåŒ…ç‰ˆæœ¬å·ï¼Œéµå¾ªï¼š`ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢å·` æ ¼å¼*ï¼ˆå¿…å¡«é¡¹ï¼‰*
- `description`ï¼šåŒ…çš„åŠŸèƒ½æè¿°*ï¼ˆå¼ºçƒˆæ¨èå­—æ®µï¼‰*
- `type`ï¼šé»˜è®¤æ¨¡å—ç±»å‹ï¼Œå¯é€‰å€¼ï¼šcommonjsï¼Œmoduleï¼Œumd*ï¼ˆå¼ºçƒˆæ¨èå­—æ®µï¼‰*
- `main`ï¼šCommonJS å…¥å£ï¼ŒNode.js `require()` åŠ è½½çš„è·¯å¾„ï¼Œå¦‚ `./dist/index.cjs.js`
- `module`ï¼šESM å…¥å£ï¼Œç°ä»£æ‰“åŒ…å·¥å…·ï¼ˆå¦‚ Rollupï¼‰ä¼˜å…ˆä½¿ç”¨çš„è·¯å¾„
- `types`ï¼šTSç±»å‹å£°æ˜å…¥å£ï¼Œæä¾›ç±»å‹æç¤ºï¼Œå…¥ï¼š`./dist/index.d.ts`*ï¼ˆå¼ºçƒˆæ¨èå­—æ®µï¼‰*
- `exports`ï¼šæ¡ä»¶å¯¼å‡ºï¼ˆNode 12+ï¼‰*ï¼ˆå¼ºçƒˆæ¨èå­—æ®µï¼‰*
  - `import`ï¼šESM ç¯å¢ƒ
  - `require`ï¼šCJS ç¯å¢ƒ
  - `types`ï¼šç±»å‹å£°æ˜
- `files`ï¼šå‘å¸ƒç™½åå•ï¼ŒæŒ‡å®šå‘å¸ƒåˆ° npm çš„æ–‡ä»¶ï¼Œå¦‚ `["dist/**/*"]`
- `scripts`ï¼šè‡ªå®šä¹‰è„šæœ¬å‘½ä»¤
- `buildOptions`ï¼šè‡ªå®šä¹‰æ„å»ºé…ç½®ï¼Œéæ ‡å‡†å­—æ®µï¼Œé€šå¸¸è¢«æ„å»ºå·¥å…·è¯»å–ï¼š
  - `formats`ï¼šè¾“å‡ºæ ¼å¼ï¼ˆESM/CJS/UMDï¼‰
  - `name`ï¼šUMD å…¨å±€å˜é‡å
- `keywords`ï¼šnpm æœç´¢å…³é”®å­—
- `author`ï¼šä½œè€…ä¿¡æ¯ï¼Œæ ¼å¼ï¼šåå­— <é‚®ç®±> æˆ–å¯¹è±¡å½¢å¼
- `license`ï¼šå¼€æºåè®®ï¼Œå¸¸ç”¨å€¼ï¼š`MIT`/`ISC`/`Apache-2.0`ã€‚*ï¼ˆå¼ºçƒˆæ¨èå­—æ®µï¼‰*
- `repository`ï¼šä»£ç ä»“åº“ï¼ŒGit åœ°å€ï¼Œå¦‚ `https://github.com/xxx.git`
- `bugs`ï¼šé—®é¢˜åé¦ˆé“¾æ¥ï¼Œé€šå¸¸æŒ‡å‘ issues é¡µé¢
- `homepage`ï¼šé¡¹ç›®ä¸»é¡µï¼Œæ–‡æ¡£æˆ–å®˜ç½‘åœ°å€

### `bable.config.json`

```js
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "usage",
        "corejs": 3,
        "modules": false
      }
    ],
    "@babel/preset-typescript"
  ]
}
```

### **`.browserslistrc`** (Options)

`.browserlistrc` æ–‡ä»¶æ˜¯ Autoprefixerã€Babel ç­‰å‰ç«¯å·¥å…·ç”¨æ¥ç¡®å®šéœ€è¦å…¼å®¹å“ªäº›æµè§ˆå™¨ç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶ï¼Œé…ç½®å†…å®¹å¦‚ä¸‹ï¼š

```
> 1%             # å…¨çƒä½¿ç”¨ç‡è¶…è¿‡1%çš„æµè§ˆå™¨
last 2 version   # æ¯ä¸ªæµè§ˆå™¨çš„æœ€å2ä¸ªç‰ˆæœ¬
not dead         # æ’é™¤å·²åœæ­¢ç»´æŠ¤çš„æµè§ˆå™¨ï¼ˆå¦‚IE10ä»¥ä¸‹ï¼‰
```

> æç¤ºï¼š
>
> - åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ `npx browserslist` æŒ‡ä»¤å¯æŸ¥è¯¢æ‰€æœ‰ä¸é…ç½®åŒ¹é…çš„æµè§ˆå™¨åˆ—è¡¨ã€‚
> - è®¿é—® [browserslist.dev](https://browserslist.dev) è¾“å…¥ä½ çš„é…ç½®ï¼Œå¯å®æ—¶æŸ¥çœ‹åŒ¹é…ç»“æœ
>
> ä½ å¯ä»¥åœ¨ [è¿™é‡Œ >>](https://caniuse.com/usage-table) æŸ¥çœ‹å½“å‰å„ä¸»æµæµè§ˆå™¨çš„å…¼å®¹æ€§æƒ…å†µï¼Œå½“æˆ‘ä»¬åœ¨æ‰“åŒ…æ ·å¼å’Œè„šæœ¬æ—¶ï¼Œå°†æ ¹æ®è¿™é‡Œçš„é…ç½®è¿›è¡Œå…¼å®¹ã€‚

### `rollup.config.mjs`

```js
import { readFileSync } from 'fs'
import { defineConfig } from 'rollup'
import { nodeResolve } from '@rollup/plugin-node-resolve'
import { babel } from '@rollup/plugin-babel'
import typescript from '@rollup/plugin-typescript'
import commonjs from '@rollup/plugin-commonjs'
import alias from '@rollup/plugin-alias'
import del from 'rollup-plugin-delete'
import eslint from '@rollup/plugin-eslint'
import terser from '@rollup/plugin-terser'
import generatePackageJson from 'rollup-plugin-generate-package-json'

// -- å·¥å…·å‡½æ•°
const resolvePath = filePath => new URL(filePath, import.meta.url).pathname

// -- å˜é‡ä¿¡æ¯
const isProduction = process.env.NODE_ENV === 'production'
const distPath = resolvePath('dist')
const pkg = JSON.parse(readFileSync(new URL('./package.json', import.meta.url), 'utf8'))

// -- å…¬å…±é…ç½®
const commonPlugins = [
  del({ targets: 'dist/*' }),
  nodeResolve(),
  commonjs(),
  alias({
    entries: [{ find: '@', replacement: './src' }],
  }),
  eslint({
    include: ['.'],
    exclude: ['node_modules/**'],
    throwOnError: true, // å‡ºç°ESLinté”™è¯¯æ—¶ï¼Œæ‰“æ–­æ‰“åŒ…è¿›ç¨‹
    throwOnWarning: true, // å‡ºç°ESLintè­¦å‘Šæ—¶ï¼Œæ‰“æ–­æ‰“åŒ…è¿›ç¨‹
  }),
  typescript({
    tsconfig: resolvePath('tsconfig.json'),
    sourceMap: !isProduction,
  }),
  babel({
    extensions: ['.js', '.ts'],
    exclude: 'node_modules/**',
    babelHelpers: 'bundled',
  }),
  generatePackageJson({
    inputFolder: resolvePath('.'),
    outputFolder: resolvePath('dist'),
    baseContents: pkg => ({
      name: pkg.name,
      description: pkg.description,
      version: pkg.version,
      types: pkg.types,
      main: pkg.main,
      module: pkg.module,
      exports: pkg.exports,
    }),
  }),
]

// -- å¼€å‘é…ç½®
const devPlugins = []

// -- ç”Ÿäº§é…ç½®
const proPlugins = [
  terser({
    compress: {
      drop_console: isProduction,
      drop_debugger: isProduction,
    },
    format: {
      comments: (_, comment) => {
        return /eslint\-disable/.test(comment.value) // ä¸åˆ é™¤eslintçš„æ³¨é‡Š
      },
    },
  }),
]

// -- é…ç½®
export default defineConfig({
  input: resolvePath('src/index.ts'),
  output: pkg.buildOptions.formats.map(format => ({
    file: `${distPath}/index.${format}.js`,
    format,
    sourcemap: !isProduction,
    banner: '/* eslint-disable */\n',
    name: ['iife', 'umd'].includes(format) ? pkg.buildOptions.name : undefined,
  })),
  plugins: [...commonPlugins, ...(isProduction ? proPlugins : devPlugins)],
})

```

## 5. æºç 

```ts
// src/index.js
export default class vTools {
	/**
	 * SUMï¼šæ±‚å’Œ
	 * @param a
	 * @param b
	 * @returns
	 */
	static sum(a: number, b: number) {
		return a + b;
	}
}
```

## 6. æ‰“åŒ…

```shell
$ pnpm build:pro
```

## 7. å‘å¸ƒ

åœ¨æ­£å¼å‘å¸ƒä¹‹å‰ï¼Œå»ºè®®å…¨å±€å®‰è£… `package-json-validator`ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨æ£€æŸ¥ `package.json` æ–‡ä»¶æ ¼å¼è§„èŒƒæ€§å’Œå®Œæ•´æ€§çš„ npm æ’ä»¶ï¼Œèƒ½å¿«é€Ÿè¯†åˆ«ç¼ºå¤±å­—æ®µã€æ— æ•ˆå€¼æˆ–ä¸æ¨èå†™æ³•ï¼Œç¡®ä¿é…ç½®ç¬¦åˆ npm å‘å¸ƒæ ‡å‡†ã€‚

```shell
# å®‰è£…
$ npm install package-json-validator -g
# æ£€æŸ¥
$ pjv
```

æ²¡é—®é¢˜ä¹‹åï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œå‘å¸ƒï¼š
```shell
$ npm publish --access public
```

**é‡è¦æç¤º**ï¼šå‘å¸ƒ npm åŒ…æ—¶å¿…é¡»ä½¿ç”¨å®˜æ–¹æºï¼ˆhttps://registry.npmjs.org/ï¼‰ï¼Œè‹¥å½“å‰é…ç½®ä¸ºæ·˜å®é•œåƒï¼Œéœ€å…ˆåˆ‡æ¢å›å®˜æ–¹æºæ‰èƒ½æˆåŠŸå‘å¸ƒã€‚

æ“ä½œæ­¥éª¤ï¼š

1. æ£€æŸ¥å½“å‰æº

   ```shell
   $ npm config get registry
   ```

2. ä¸´æ—¶åˆ‡æ¢è‡³å®˜æ–¹æº

   ```shell
   $ npm config set registry https://registry.npmjs.org/
   ```

3. å‘å¸ƒå®Œæˆåå¯å›å¤æ·˜å®æºï¼ˆå¯é€‰ï¼‰

   ```shell
   $ npm config set registry https://registry.npmmirror.com
   ```

### è‡ªåŠ¨å‘å¸ƒè„šæœ¬é…ç½®

å‚è€ƒï¼š[ã€å®˜æ–¹ã€‘Using-npm Scripts](https://docs.npmjs.com/cli/v11/using-npm/scripts)

```json
{
  "scripts": {
    "preversion": "npm run lint && npm run build:pro",     // å‰ç½®æ£€æŸ¥ï¼šä»£ç è§„èŒƒ + ç”Ÿäº§æ„å»º
    "version": "npm pkg fix && git add package.json package-lock.json",  // è‡ªåŠ¨ä¿®å¤æ ¼å¼å¹¶æš‚å­˜æ–‡ä»¶
    "postversion": "npm publish --access public",          // è‡ªåŠ¨å‘å¸ƒåˆ° npm
    "postpublish": "git push origin HEAD --follow-tags && echo 'âœ… Published!'"  // å®‰å…¨æ¨é€ä»£ç å’Œæ ‡ç­¾
  }
}
```

> æç¤ºï¼šæ ¹æ®éœ€è¦è°ƒæ•´æŒ‡ä»¤ï¼Œè§¦å‘æŒ‡ä»¤ä¹‹åçš„æ‰§è¡Œæµç¨‹ä¸º  `preversion` â†’ `version` â†’ `postversion` â†’ `postpublish` 

1ï¸âƒ£ è§¦å‘å‘½ä»¤

```bash
$ npm version patch|minor|major  # é€‰æ‹©ç‰ˆæœ¬å‡çº§ç±»å‹
```

2ï¸âƒ£ **è‡ªåŠ¨åŒ–æµç¨‹**

```mermaid
graph TB
A[ç”¨æˆ·æ‰§è¡Œ npm version] --> B[preversion]
B --> C[lint+æ„å»ºç”Ÿäº§åŒ…]
C --> D[version]
D --> E[ä¿®å¤package.jsonæ ¼å¼]
E --> F[æäº¤ç‰ˆæœ¬æ–‡ä»¶]
F --> G[postversion]
G --> H[å‘å¸ƒåˆ°npm]
H --> I[postpublish]
I --> J[æ¨é€ä»£ç +æ ‡ç­¾]
```

# æ·±å…¥è§£æ Rollup è¾“å‡ºæ ¼å¼ï¼šå‰ç«¯æ„å»ºçš„æ ¸å¿ƒåŸç†

ä¸ºä»€ä¹ˆéœ€è¦æŒæ¡ Rollup çš„æ‰“åŒ…æ ¼å¼ï¼Ÿéšç€ Vite.js åœ¨å‰ç«¯å·¥ç¨‹ä¸­çš„æ—¥ç›Šæ™®åŠï¼Œè¿™ä¸ªé—®é¢˜å˜æˆäº†å·¥ä½œç”Ÿäº§å’Œé¢è¯•é—®ç­”æ—¶ç»å¸¸è¢«æåŠçš„é—®é¢˜ã€‚ä½œä¸º Vite æ„å»ºæ ¸å¿ƒçš„ Rollup.jsï¼Œå…¶è¾“å‡ºæ ¼å¼ç›´æ¥å†³å®šäº†é¡¹ç›®çš„è¿è¡Œæœºåˆ¶ã€‚åœ¨å­¦ä¹ è¿™äº›å·¥å…·ä¹‹å‰ï¼Œæ·±å…¥ç†è§£ JavaScript æ¨¡å—åŒ–è§„èŒƒè‡³å…³é‡è¦â€”â€”å› ä¸ºåªæœ‰æ˜ç™½æ‰“åŒ…äº§ç‰©çš„æœ¬è´¨å’Œè¿è¡ŒåŸç†ï¼Œæ‰èƒ½çœŸæ­£æŒæ¡å‰ç«¯æ„å»ºçš„ç²¾é«“ã€‚åœ¨ç¼–ç¨‹å­¦ä¹ ä¸­ï¼Œç›²ç›®å´‡æ‹œå·¥å…·"é­”æ³•"æ˜¯ä¸å¯å–çš„ï¼Œä¿æŒå¯¹æŠ€æœ¯åŸç†çš„å¥½å¥‡å¿ƒå’Œæ¢ç´¢æ¬²ï¼Œæ‰æ˜¯æŒç»­è¿›æ­¥çš„é˜¶æ¢¯ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬è§£å¼€ç¥ç§˜çš„é¢çº±ï¼Œçœ‹çœ‹é‚£äº›æ‰“åŒ…åçš„ä»£ç ï¼Œéƒ½æ˜¯äº›ä»€ä¹ˆç©æ„å„¿ï¼

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´ç¤ºä¾‹ï¼Œå¸®åŠ©å¤§å®¶ç†è§£æ¨¡å—åŒ–è§„èŒƒçš„å‡ ç§ä¸»è¦æ ¼å¼ã€‚

## å‡†å¤‡å·¥ä½œ

é¦–å…ˆåˆ›å»ºé¡¹ç›®å¹¶åˆå§‹åŒ–é…ç½®ï¼š

```shell
$ mkdir rollup-formats && cd rollup-formats && npm init -y  && mkdir src && touch src/{index,answer}.js rollup.config.mjs && pnpm add rollup -D && pnpm add lodash lodash-es jquery && code .
```

é¡¹ç›®ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```
rollup-formats
.
â”œâ”€â”€ node_modules
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ anwser.js
â”‚	  â””â”€â”€ index.js
â”œâ”€â”€ package.json
â””â”€â”€ rollup.config.js
```

å…¶ä¸­ `index.js` å’Œ `answer.js` æ˜¯ä¸šåŠ¡ä»£ç ï¼Œå°†è¢«ä½œä¸ºæ‰“åŒ…å¯¹è±¡ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

> `anwser.js`

```js
export default 30;
```

> `index.js`

```js
import answer from "./answer";
import { repeat } from "lodash";

// -- å®šä¹‰ä¸€ä¸ªæ— ç”¨å˜é‡ï¼Œæµ‹è¯•tree-shaking
const unUsedVar = "Hello, Rollup!";

export const printAnswer = () => {
  // 1. æ‰“å°è¾“å‡º
  console.log(`The answer is ${answer}.`);
  // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
  console.log(repeat("1", answer));
};
```

> `rollup.config.mjs`

```js
import { defineConfig } from "rollup";

export default defineConfig({
  // å¤–éƒ¨ä¾èµ–å£°æ˜ï¼ˆä¸æ‰“åŒ…lodashï¼‰
  external: ["lodash"],
  // å…¥å£æ–‡ä»¶
  input: new URL("src/index.js", import.meta.url).pathname,
  // å¤šæ ¼å¼è¾“å‡ºé…ç½®
  output: [
    // IIFE æ ¼å¼ï¼ˆæµè§ˆå™¨ç›´æ¥ä½¿ç”¨ï¼‰
    {
      file: "dist/iife/bundle.js",
      format: "iife",
      name: "Test", // å…¨å±€å˜é‡å
      globals: { lodash: "lodash" }, // å¤–éƒ¨ä¾èµ–å…¨å±€å˜é‡æ˜ å°„
    },

    // CommonJS æ ¼å¼
    {
      file: "dist/cjs/bundle.js",
      format: "cjs",
    },
    // AMD æ ¼å¼
    {
      file: "dist/amd/bundle.js",
      format: "amd",
      amd: { id: "Test" }, // æ¨¡å—ID
    },

    // ESM æ ¼å¼
    {
      file: "dist/esm/bundle.js",
      format: "esm",
    },

    // UMD æ ¼å¼ï¼ˆé€šç”¨æ¨¡å—å®šä¹‰ï¼‰
    {
      file: "dist/umd/bundle.js",
      format: "umd",
      name: "Test", // å…¨å±€å˜é‡å
      globals: { lodash: "lodash" },
      amd: { id: "Test" }, // åŒæ—¶æ”¯æŒAMD
    },

    // SystemJS æ ¼å¼
    {
      file: "dist/system/bundle.js",
      format: "system",
    },
  ],
});

```

> `package.json`

```json
{
  "name": "rollup-formats",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "build": "rollup -c --bundleConfigAsCjs"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "devDependencies": {
    "rollup": "^4.39.0"
  },
  "dependencies": {
    "jquery": "^3.7.1",
    "lodash": "^4.17.21",
    "lodash-es": "^4.17.21"
  }
}
```

æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼š

```shell
$ pnpm build
```

## æ¨¡å—è§£è¯»

### 1. IIFEï¼ˆç«‹å³æ‰§è¡Œå‡½æ•°ï¼‰

#### æ‰“åŒ…ç»“æœåˆ†æ

`dist/iife/bundle.js` å†…å®¹

```js
var Test = (function (exports, lodash) {
  "use strict";

  var answer = 30;

  const printAnswer = () => {
    // 1. æ‰“å°è¾“å‡º
    console.log(`The answer is ${answer}.`);
    // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
    console.log(lodash.repeat("1", answer));
  };

  exports.printAnswer = printAnswer;

  return exports;
})({}, lodash);
```

äº§ç‰©åˆ†æï¼š

```js
// -- exports æ˜¯ç¬¬ä¸€ä¸ªå…¥å‚ï¼Œä¾èµ–çš„ lodash æ˜¯ç¬¬äºŒä¸ªå…¥å‚
var Test = (function (exports, lodash) {
  // -- è‡ªå¸¦ä¸¥æ ¼æ¨¡å¼ï¼Œé¿å…ä¸€äº›å¥‡æ€ªçš„å…¼å®¹æ€§é—®é¢˜
  "use strict";

  // -- ä¸‹é¢ä»£ç å› ä¸ºæ²¡æœ‰è¢«ä½¿ç”¨ï¼Œè¢« tree-shaking æ‰äº†
  // const unUsedVar = 'Hello, Rollup!';

  // -- ä¸šåŠ¡ä¸­è¢«å•ä¸€å¼•ç”¨çš„æ¨¡å—ï¼Œè¢«ç›´æ¥æŠ¹å¹³
  var answer = 30;

  const printAnswer = () => {
    // 1. æ‰“å°è¾“å‡º
    console.log(`The answer is ${answer}.`);
    // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
    console.log(lodash.repeat("1", answer));
  };

  // -- æŠŠè¦exportçš„å±æ€§æŒ‚åœ¨åˆ°exportsä¸Š
  exports.printAnswer = printAnswer;

  return exports;
})({}, lodash);

```

IIFE æ˜¯å‰ç«¯æ¨¡å—åŒ–æ—©æœŸçš„äº§ç‰©ï¼Œå…¶æ ¸å¿ƒæ€è·¯æ˜¯ï¼š

1. æ„å»ºä¸€ä¸ªåŒ¿åå‡½æ•°
2. ç«‹å³æ‰§è¡Œè¿™ä¸ªåŒ¿åå‡½æ•°ï¼Œå¤–éƒ¨ä¾èµ–é€šè¿‡å…¥å‚å½¢å¼ä¼ å…¥
3. è¿”å›æ¨¡å—è¾“å‡º

#### è¿è¡Œæ–¹å¼

IIFE çš„è¿è¡Œå…¶å®å¾ˆç®€å•ï¼Œå¦‚æœå®ƒæ²¡æœ‰å…¶ä»–ä¾èµ–ï¼Œåªéœ€è¦å»å¼•å…¥æ–‡ä»¶ï¼Œç„¶ååœ¨ window ä¸Šå–ç›¸åº”çš„å˜é‡å³å¯ï¼Œæ¯”å¦‚ jQueryï¼š

```html
<script src="http://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script>window.$</script>
```

ä½†æ˜¯å¦‚æœä½ åƒæœ¬ç¤ºä¾‹ä¸­é‚£æ ·ä¾èµ–äº†å…¶ä»–çš„æ¨¡å—ï¼ˆè¿™é‡Œå¼•ç”¨äº† lodashï¼‰ï¼Œé‚£å°±å¿…é¡»ä¿è¯ä»¥ä¸‹ä¸¤ç‚¹æ‰èƒ½æ­£å¸¸è¿è¡Œï¼š

1. ä¾èµ–åŒ…å·²é¢„å…ˆåŠ è½½
2. å…¨å±€å˜é‡åä¸IIFEå…¥å‚ä¸€è‡´

ä»¥æœ¬ç¤ºä¾‹ä¸­ IIFE æ„å»ºç»“æœä¸ºä¾‹ï¼š

1. å®ƒå‰ç½®ä¾èµ–äº† `lodash`ï¼Œå› æ­¤éœ€è¦åœ¨å®ƒåŠ è½½ä¹‹å‰å®Œæˆ `lodash` çš„åŠ è½½ã€‚
2. æ­¤ `IIFE` çš„ç¬¬äºŒä¸ªå…¥å‚æ˜¯ `lodash`ï¼Œä½œä¸ºå‰ç½®æ¡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦è®© `window.lodash` ä¹ŸæŒ‡å‘ `lodash`ã€‚ 

å› æ­¤ï¼Œè¿è¡Œæ—¶ï¼Œä»£ç å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IIFE</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script>window.lodash = window._;</script>
    <script src="../dist/iife/bundle.js"></script>
  </head>

  <body>
    <script>
      window.Test.printAnswer();
    </script>
  </body>
</html>
```

#### ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹:
  1. é€šè¿‡é—­åŒ…åˆ›å»ºç§æœ‰å‘½åç©ºé—´
  2. ç®€å•æ˜“æ‡‚
  3. å¯¹ä»£ç ä½“ç§¯å½±å“å°
- ç¼ºç‚¹ï¼š
  1. è¾“å‡ºçš„å˜é‡å¯èƒ½å½±å“å…¨å±€å˜é‡ / å¼•å…¥ä¾èµ–åŒ…æ—¶ä¾èµ–å…¨å±€å˜é‡ã€‚
  2. éœ€è¦æ‰‹åŠ¨ç»´æŠ¤scriptåŠ è½½é¡ºåºã€‚

ä¼˜ç‚¹å°±ä¸ç»†è¯´äº†ï¼Œç¼ºç‚¹è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚

**ç¼ºç‚¹ä¸€ï¼šè¾“å‡ºçš„å˜é‡å¯èƒ½å½±å“å…¨å±€å˜é‡ / å¼•å…¥ä¾èµ–åŒ…æ—¶ä¾èµ–å…¨å±€å˜é‡**ã€‚

å‰åŠå¥ï¼š**è¾“å‡ºçš„å˜é‡å¯èƒ½å½±å“å…¨å±€å˜é‡**  å…¶å®å¾ˆå¥½ç†è§£ï¼Œä»¥ä¸Šé¢ç¤ºä¾‹çš„è¾“å‡ºä¸ºä¾‹ï¼š `window.Test` å°±å·²ç»è¢«å½±å“äº†ã€‚è¿™ç§æ˜æ˜¾çš„å‰¯ä½œç”¨åœ¨ç¨‹åºä¸­å…¶å®æ˜¯æœ‰éšæ‚£çš„ã€‚

ååŠå¥ï¼š**å¼•å…¥ä¾èµ–åŒ…æ—¶ä¾èµ–å…¨å±€å˜é‡** æˆ‘ä»¬ä¸ºäº†è®©ç¤ºä¾‹æ­£å¸¸è¿è¡Œï¼Œå› æ­¤åŠ äº†ä¸€è¡Œä»£ç è®© `window.lodash` ä¹ŸæŒ‡å‘ `lodash`ï¼Œä½†å®ƒç¡®å®æ˜¯å¤ªè„†å¼±äº†ã€‚

```html
<!-- æ²¡æœ‰è¿™ä¸€è¡Œï¼Œç¤ºä¾‹å°±æ— æ³•æ­£å¸¸è¿è¡Œ -->
<script>window.lodash = window._</script>
```

ä½ ç§ï¼ŒIIFE çš„æ‰§è¡Œå¯¹ç¯å¢ƒçš„ä¾èµ–æ˜¯è‹›åˆ»çš„ï¼Œé™¤éå®ƒå®Œå…¨ä¸ä¾èµ–å¤–éƒ¨åŒ…ã€‚ï¼ˆjQuery: æ­£æ˜¯åœ¨ä¸‹ï¼ï¼‰

è™½ç„¶ IIFE çš„ç¼ºç‚¹å¾ˆå¤šï¼Œä½†å¹¶ä¸å¦¨ç¢å®ƒåœ¨ jQuery æ—¶ä»£æå¤§åœ°æ¨åŠ¨äº†Webå¼€å‘çš„è¿›ç¨‹ï¼Œå› ä¸ºå®ƒç¡®å®è§£å†³äº† js æœ¬èº«å­˜åœ¨çš„å¾ˆå¤šé—®é¢˜ã€‚

é‚£ä¹ˆï¼Ÿåç»­æ˜¯å¦è¿˜æœ‰ **æ›´ä¸ºä¼˜ç§€** çš„å‰ç«¯æ¨¡å—åŒ–æ–¹æ¡ˆé—®ä¸–å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œå¾€ä¸‹çœ‹å§ã€‚

### 2. CommonJS

#### æ‰“åŒ…ç»“æœåˆ†æ

`dist/cjs/bundle.js` å†…å®¹ï¼š

```js
'use strict';

var lodash = require('lodash');

var answer = 30;

const printAnswer = () => {
  // 1. æ‰“å°è¾“å‡º
  console.log(`The answer is ${answer}.`);
  // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
  console.log(lodash.repeat("1", answer));
};

exports.printAnswer = printAnswer;
```

CommonJS è§„èŒƒç‰¹ç‚¹ï¼š

- é€šè¿‡ `require` å¼•å…¥æ¨¡å—
- é€šè¿‡ `exports` æˆ– `module.exports` è¾“å‡ºæ¨¡å—

ä¸ºäº†è§£å†³ Node.js åœ¨æ¨¡å—åŒ–ä¸Šçš„ç¼ºå¤±ï¼Œ **2009å¹´10æœˆ**ï¼ŒCommonJS è§„èŒƒé¦–æ¬¡è¢«æå‡ºã€‚

æ³¨æ„è¿™ä¸ªå…³é”®è¯ï¼š **Node.js**ï¼Œæ˜¯çš„ï¼ŒCommonJS å¹¶ä¸æ˜¯åœ¨æµè§ˆå™¨ç¯å¢ƒè¿è¡Œçš„è§„èŒƒï¼Œè€Œæ˜¯åœ¨ Node.js ç¯å¢ƒä¸‹è¿è¡Œçš„ã€‚

#### è¿è¡Œæ–¹å¼

åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¹¶æ‰§è¡Œï¼š

```js
// run.js
const Test = require('../dist/cjs/bundle');
Test.printAnswer();
```

```shell
# æ‰§è¡Œè„šæœ¬
node ./examples/run.js

# è¾“å‡ºå†…å®¹
> The answer is 30.
> 111111111111111111111111111111
```

#### ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹ï¼šå®Œå–„çš„æ¨¡å—åŒ–æ–¹æ¡ˆï¼Œè§£å†³äº† IIFE çš„å„ç§ç¼ºç‚¹ã€‚
- ç¼ºç‚¹ï¼šåŒæ­¥åŠ è½½ï¼Œæµè§ˆå™¨ä¸æ”¯æŒã€‚

å› æ­¤ï¼Œå‰ç«¯ç•Œè¿«åˆ‡åœ°éœ€è¦ä¸€ç§èƒ½åœ¨æµè§ˆå™¨ç¯å¢ƒè¿è¡Œçš„æ¨¡å—åŒ–æ–¹æ¡ˆã€‚

### 3. AMD & require.js

2011å¹´ï¼ŒAMDï¼ˆAsynchronous Module Definitionï¼‰è§„èŒƒæ­£å¼å‘å¸ƒï¼Œä¸ºæµè§ˆå™¨ç«¯å¸¦æ¥äº†æˆç†Ÿçš„æ¨¡å—åŒ–æ–¹æ¡ˆã€‚

#### æ‰“åŒ…ç»“æœåˆ†æ

`dist/amd/bundle.js` å†…å®¹ï¼š

```js
define('Test', ['exports', 'lodash'], (function (exports, lodash) { 'use strict';

  var answer = 30;

  const printAnswer = () => {
    // 1. æ‰“å°è¾“å‡º
    console.log(`The answer is ${answer}.`);
    // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
    console.log(lodash.repeat("1", answer));
  };

  exports.printAnswer = printAnswer;

}));
```

å…³é”®ç‰¹æ€§è§£æï¼š

- **æ¨¡å—å®šä¹‰**ï¼šé€šè¿‡å…¨å±€`define`å‡½æ•°å£°æ˜æ¨¡å—
- **ä¾èµ–å£°æ˜**ï¼šæ•°ç»„å½¢å¼å£°æ˜å¤–éƒ¨ä¾èµ–ï¼ˆ`exports`å’Œ`lodash`ï¼‰
- **å·¥å‚å‡½æ•°**ï¼šæ¥æ”¶ä¾èµ–é¡¹ä½œä¸ºå‚æ•°ï¼Œè¿”å›æ¨¡å—å®ç°

require.js æ˜¯ AMD æ ‡å‡†å®ç°æ–¹æ¡ˆï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œä¸€èˆ¬éµå¾ªä»¥ä¸‹å››æ­¥æ³•ï¼š

1. åœ¨æµè§ˆå™¨å†…å¼•å…¥ `require.js`
2. é€šè¿‡ `requirejs.config` æ–¹æ³•å®šä¹‰å…¨å±€çš„ä¾èµ–
3. é€šè¿‡ `requirejs.define` æ³¨å†Œæ¨¡å—
4. é€šè¿‡ `requirejs()` å®Œæˆæ¨¡å—å¼•å…¥ã€‚

#### è¿è¡Œæ–¹å¼

ä½¿ç”¨ require.js åŠ è½½ï¼Œä½ å¯ä»¥åœ¨ [è¿™é‡Œ >>](https://requirejs.org/docs/release/2.3.6/minified/require.js) ä¸‹è½½

```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AMD</title>
    <!-- 1. å¼•å…¥.requirejs -->
    <script src="./requirejs.js"></script>
    <!-- 2. å®šä¹‰å…¨å±€ä¾èµ– -->
    <script>
      window.requirejs.config({
        paths: {
          lodash: "https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min",
        },
      });
    </script>
    <!-- 3. å®šä¹‰æ¨¡å— -->
    <script src="../dist/amd/bundle.js"></script>
  </head>

  <body>
    <!-- 4. æ¶ˆè´¹æ¨¡å— -->
    <script>
      window.requirejs(["Test"], function (test) {
        test.printAnswer();
      });
    </script>
  </body>
</html>
```

#### ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹
  1. **å¼‚æ­¥åŠ è½½**ï¼šé¿å…é˜»å¡é¡µé¢æ¸²æŸ“
  2. **ä¾èµ–ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†æ¨¡å—ä¾èµ–å…³ç³»
  3. **è·¯å¾„æ˜ å°„**ï¼šæ”¯æŒè‡ªå®šä¹‰æ¨¡å—è·¯å¾„

- ç¼ºç‚¹ï¼šä»£ç ç»„ç»‡æ–¹å¼ä¸å¤Ÿç›´è§‚

ä½†å¥½åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†å„ç±»æ‰“åŒ…å·¥å…·ï¼Œæµè§ˆå™¨å†…çš„ä»£ç å¯è¯»æ€§å†å·®ä¹Ÿå¹¶ä¸å½±å“æˆ‘ä»¬å†™å‡ºå¯è¯»æ€§okçš„ä»£ç ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬æ‹¥æœ‰äº†**é¢å‘ Node.js çš„ CommonJs** å’Œ **é¢å‘æµè§ˆå™¨çš„ AMD** ä¸¤å¥—æ ‡å‡†ã€‚

å¦‚æœæˆ‘å¸Œæœ›æˆ‘å†™å‡ºçš„ä»£ç èƒ½åŒæ—¶è¢« **æµè§ˆå™¨** å’Œ **Node.js** è¯†åˆ«ï¼Œæˆ‘åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

### 4. UMD ä¼Ÿå¤§çš„æ•´åˆ

å®ƒæ²¡æœ‰åšä»€ä¹ˆçªç ´æ€§çš„åˆ›é€ ï¼Œä½†å®ƒæ˜¯é›†å¤§æˆè€…ã€‚

å®ƒå¯ä»¥åœ¨ `<script>` æ ‡ç­¾ä¸­æ‰§è¡Œï¼Œè¢« CommonJS æ¨¡å—åŠ è½½å™¨åŠ è½½ã€è¢« AMD æ¨¡å—åŠ è½½å™¨åŠ è½½ã€‚

#### æ‰“åŒ…ç»“æœåˆ†æ

UMD æ ¼å¼æ„å»ºå‡ºæ¥çš„ä»£ç çš„å¯è¯»æ€§è¿›ä¸€æ­¥é™ä½äº†ï¼Œæˆ‘ç›¸ä¿¡ä»»ä½•æ­£å¸¸äººçœ‹åˆ°ä¸‹é¢è¿™æ®µä»£ç éƒ½ä¼šæ„Ÿåˆ°ä¸€é˜µå¤´å¤§ã€‚

`dist/umd/bundle.js` å†…å®¹ï¼š

```js
(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('lodash')) :
  typeof define === 'function' && define.amd ? define('Test', ['exports', 'lodash'], factory) :
  (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.Test = {}, global.lodash));
})(this, (function (exports, lodash) { 'use strict';

  var answer = 30;

  const printAnswer = () => {
    // 1. æ‰“å°è¾“å‡º
    console.log(`The answer is ${answer}.`);
    // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
    console.log(lodash.repeat("1", answer));
  };

  exports.printAnswer = printAnswer;

}));

```

UMD ç‰¹ç‚¹ï¼š

- å…¼å®¹ AMD å’Œ CommonJS
- è‡ªåŠ¨åˆ¤æ–­ç¯å¢ƒé€‰æ‹©åŠ è½½æ–¹å¼

æ˜¯çš„ï¼Œæ•´æ•´ä¸€å¤§æ®µä»£ç ï¼Œåªæ˜¯åœ¨å¤„ç†å…¼å®¹æ€§é—®é¢˜ï¼Œåˆ¤æ–­å½“å‰åº”è¯¥ä½¿ç”¨AMDè¿˜æ˜¯CommonJSã€‚

å› æ­¤UMDçš„ä»£ç å’Œå®ç°ä¸åœ¨æ­¤è¿›è¡Œè¿‡å¤šåˆ†æï¼Œå®ƒæ‰€åšçš„æ— éä¾¿æ˜¯è®©åŒä¸€æ®µä»£ç å…¼å®¹äº†AMDå’ŒCommonJSè§„èŒƒã€‚

#### è¿è¡Œæ–¹å¼

ä¸ AMD å’Œ CommonJS ç›¸åŒ

#### ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹ï¼šè·¨ç¯å¢ƒå…¼å®¹
- ç¼ºç‚¹ï¼šç”Ÿæˆä»£ç å†—ä½™

è™½ç„¶åœ¨ç¤¾åŒºçš„ä¸æ–­åŠªåŠ›ä¸‹ï¼Œ`CommonJS` ã€ `AMD` ã€ `UMD` éƒ½ç»™ä¸šç•Œäº¤å‡ºäº†è‡ªå·±çš„ç­”å·ã€‚

ä½†å¾ˆæ˜¾ç„¶ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸å¾—å·²çš„é€‰æ‹©ã€‚

æµè§ˆå™¨åº”è¯¥æœ‰è‡ªå·±çš„åŠ è½½æ ‡å‡†ã€‚

ES6 è‰æ¡ˆé‡Œï¼Œè™½ç„¶æè¿°äº†æ¨¡å—åº”è¯¥å¦‚ä½•è¢«åŠ è½½ï¼Œä½†å®ƒæ²¡æœ‰ â€œåŠ è½½ç¨‹åºçš„è§„èŒƒâ€ã€‚

### 5. SystemJS

å› æ­¤ï¼ŒWHATWGï¼ˆ**W**eb **H**ypertext **A**pplication **T**echnology **W**orking **G**roupï¼Œå³ç½‘é¡µè¶…æ–‡æœ¬åº”ç”¨æŠ€æœ¯å·¥ä½œå°ç»„ï¼‰æå‡ºäº†ä¸€å¥—æ›´æœ‰è¿œè§çš„è§„èŒƒï¼š[whatwg/loader](https://github.com/whatwg/loader)ã€‚è¯¥è§„èŒƒå®šä¹‰äº†JavaScriptæ¨¡å—çš„åŠ è½½è¡Œä¸ºï¼Œå¹¶æä¾›äº†æ‹¦æˆªåŠ è½½è¿‡ç¨‹å’Œè‡ªå®šä¹‰åŠ è½½è¡Œä¸ºçš„APIã€‚ä½œä¸ºè¿™ä¸€è§„èŒƒçš„æœ€ä½³å®è·µè€…ï¼ŒSystemJSåº”è¿è€Œç”Ÿã€‚

`dist/system/bundle.js` å†…å®¹ï¼š

```js
System.register(['lodash'], (function (exports) {
  'use strict';
  var repeat;
  return {
    setters: [function (module) {
      repeat = module.repeat;
    }],
    execute: (function () {

      var answer = 30;

      const printAnswer = exports("printAnswer", () => {
        // 1. æ‰“å°è¾“å‡º
        console.log(`The answer is ${answer}.`);
        // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
        console.log(repeat("1", answer));
      });

    })
  };
}));

```

ä¸AMDç›¸æ¯”ï¼ŒSystemJSçš„ä¼˜åŠ¿ä¸ä»…ä½“ç°åœ¨è¯­æ³•ä¸Šï¼š

1. **æŒ‰éœ€åŠ è½½**ï¼šé€šè¿‡`System.import()`å®ç°çœŸæ­£çš„æ‡’åŠ è½½ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰bundle
2. **é¢å‘æœªæ¥**ï¼šåŸºäºWHATWGæ ‡å‡†è®¾è®¡ï¼Œä»£è¡¨æ¨¡å—åŠ è½½çš„å‘å±•æ–¹å‘
3. **åŠ¨æ€èƒ½åŠ›**ï¼šæ”¯æŒè¿è¡Œæ—¶æ¨¡å—åŠ è½½å’Œä¾èµ–è§£æ

### 6. ESM

ESM è¢«è®¤ä¸ºæ˜¯ **æœªæ¥**ï¼Œä½†cjsä»ç„¶åœ¨ç¤¾åŒºå’Œç”Ÿæ€ç³»ç»Ÿä¸­å æœ‰é‡è¦åœ°ä½ã€‚ESM å¯¹æ‰“åŒ…å·¥å…·æ¥è¯´æ›´å®¹æ˜“æ­£ç¡®åœ°è¿›è¡Œ treeshakingï¼Œå› æ­¤å¯¹äºåº“æ¥è¯´ï¼Œæ‹¥æœ‰è¿™ç§æ ¼å¼å¾ˆé‡è¦ã€‚æˆ–è®¸åœ¨å°†æ¥çš„æŸä¸€å¤©ï¼Œä½ çš„åº“åªéœ€è¦è¾“å‡º esmã€‚

#### æ‰“åŒ…ç»“æœåˆ†æ

`dist/esm/bundle.js` å†…å®¹ï¼š

```js
import { repeat } from 'lodash';

var answer = 30;

const printAnswer = () => {
  // 1. æ‰“å°è¾“å‡º
  console.log(`The answer is ${answer}.`);
  // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
  console.log(repeat('1', answer));
};

export { printAnswer };
```

ESM ç‰¹ç‚¹ï¼š

- åŸç”Ÿæ¨¡å—è¯­æ³•
- é™æ€åˆ†æå‹å¥½

åœ¨ ESM è¢«æå‡ºæ¥ä¹‹å‰ï¼Œjs ä¸€ç›´æ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„æ¨¡å—ä½“ç³»ã€‚

å®ƒçš„è§„èŒƒæ˜¯é€šè¿‡ `export` å‘½ä»¤æ˜¾å¼æŒ‡å®šè¾“å‡ºçš„ä»£ç ï¼Œå†é€šè¿‡ `import` å‘½ä»¤è¾“å…¥ã€‚

```js
// å¯¼å‡ºå‘½ä»¤
export { foo };
// å¯¼å…¥æ¨¡å—
import { foo } from 'bar';
```

è¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­æœ€ä¸ºç†Ÿæ‚‰çš„å†™æ³•ï¼Œå› æ­¤ï¼ŒESM æ ¼å¼æ‰“å‡ºæ¥çš„åŒ…ï¼Œå¯è¯»æ€§ç¡®å®éå¸¸æ£’ï¼Œå’Œé˜…è¯»æˆ‘ä»¬å¹³æ—¶æ‰€å†™çš„ä¸šåŠ¡ä»£ç å®Œå…¨æ²¡æœ‰åŒºåˆ«ã€‚

#### è¿è¡Œæ–¹å¼

ç°ä»£æµè§ˆå™¨ç›´æ¥æ”¯æŒï¼š

```html
<script type="module">
  import { printAnswer } from "../dist/esm/bundle.js";
  printAnswer();
</script>
```

> æç¤ºï¼š
>
> è¿è¡Œæ—¶ï¼Œä½ åº”è¯¥ä¼šåœ¨æ§åˆ¶å°çœ‹åˆ°é”™è¯¯ä¿¡æ¯ï¼š
>
> *Uncaught TypeError: Failed to resolve module specifier "lodash". Relative references must start with either "/", "./", or "../".*
>
> è¿™æ˜¯å› ä¸ºé»˜è®¤çš„ lodash å¹¶ä¸æ˜¯è¾“å‡ºçš„ ESM æ ¼å¼ï¼Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´ä¸‹ `dist/esm/bundle.js` ä»£ç ï¼Œå¦‚ä¸‹ï¼š
>
> ```js
> - import { repeat } from "lodash";
> + import repeat from '../../node_modules/lodash-es/repeat.js';
> ...
> ```

## æ€»ç»“ï¼šåˆ†åˆ«é€‚åˆåœ¨ä»€ä¹ˆåœºæ™¯ä½¿ç”¨ï¼Ÿ

1. **IIFE** ï¼šé€‚åˆä½œä¸ºSDKä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯éœ€è¦æŒ‚è½½åˆ°windowçš„åœºæ™¯
2. **CommonJS**ï¼š ä»…Node.jsç¯å¢ƒä½¿ç”¨çš„åº“
3. **AMD**ï¼š çº¯æµè§ˆå™¨ç«¯ä½¿ç”¨

4. **UMD**ï¼š è·¨æµè§ˆå™¨å’ŒNode.jsç¯å¢ƒä½¿ç”¨

5. **SystemJs**ï¼š éœ€è¦åŠ¨æ€åŠ è½½çš„åœºæ™¯

6. **ESM**ï¼š
   - ä¼šè¢«äºŒæ¬¡ç¼–è¯‘çš„åº“ï¼ˆå¦‚ç»„ä»¶åº“ï¼‰
   - ç°ä»£æµè§ˆå™¨ç›´æ¥è¿è¡Œ
   - å¯¹tree-shakingè¦æ±‚é«˜çš„åœºæ™¯

éšç€ESMçš„æ™®åŠï¼Œæœªæ¥å‰ç«¯æ¨¡å—åŒ–å°†è¶Šæ¥è¶Šå€¾å‘äºä½¿ç”¨åŸç”ŸESMæ ¼å¼ã€‚



